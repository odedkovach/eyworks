<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>NurseryCare - Nursery Management System</title>
  
  <!-- Import fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@400;600;700&display=swap" rel="stylesheet" />
  
  <!-- Font Awesome for icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  
  <!-- UniPaas Embedded UI -->
  <script src="https://cdn.unipaas.com/embedded-ui.js" defer></script>
  
  <style>
    /* Reset/normalize */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* Root variables for theming - Updated to match nursery software colors */
    :root {
      --primary-color: #9CAF3F;        /* Main olive-green from software headers */
      --secondary-color: #B8C65A;      /* Lighter olive for hover states */
      --tertiary-color: #7A8F32;       /* Darker olive for active states */
      --body-bg-color: #F5F4E8;        /* Light cream background */
      --menu-bg-color: #E8E6D3;        /* Light olive/beige for menu backgrounds */
      --card-bg-color: #FFFFFF;        /* White for cards and content areas */
      --table-header-bg: #9CAF3F;      /* Table header background */
      --table-row-bg: #E8E6D3;         /* Alternating table row background */
      --table-row-hover: #DDD9C4;      /* Table row hover color */
      --text-color: #2C3E50;           /* Dark text color */
      --light-text-color: #6B7280;     /* Muted text color */
      --border-color: #D1D5DB;         /* Light border color */
      --nav-height: 60px;
      --transition-speed: 0.3s;
      --sidebar-width: 231px;
      --accent-color: #F39C12;         /* Orange accent */
      --success-color: #10B981;        /* Success green */
      --warning-color: #EF4444;        /* Warning red */
      --info-color: #3B82F6;           /* Info blue for badges */
    }

    body {
      font-family: 'Inter', sans-serif;
      font-size: 16px;
      background-color: var(--body-bg-color);
      color: var(--text-color);
      line-height: 1.4;
    }

    /* TOP NAVIGATION - Updated to match nursery software */
    .top-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: var(--primary-color);
      color: white;
      height: var(--nav-height);
      padding: 0 1.5rem;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .nav-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .nursery-selector {
      display: flex;
      align-items: center;
      background: rgba(255, 255, 255, 0.1);
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .nursery-selector:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .nursery-dropdown {
      background: transparent;
      border: none;
      color: white;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      outline: none;
    }

    .nursery-dropdown option {
      background: var(--primary-color);
      color: white;
    }

    .top-menu {
      display: flex;
      align-items: center;
      gap: 2rem;
    }

    .nav-links {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .nav-link {
      color: white;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .nav-link:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .user-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .notification-badge {
      position: relative;
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 50%;
      transition: background-color 0.2s ease;
    }

    .notification-badge:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .badge-count {
      position: absolute;
      top: -2px;
      right: -2px;
      background: #EF4444;
      color: white;
      font-size: 10px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 16px;
      text-align: center;
    }

    .user-menu {
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 50%;
      transition: background-color 0.2s ease;
    }

    .user-menu:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      background: #F39C12;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      color: white;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .user-avatar:hover {
      background: #E67E22;
    }

    /* Mobile menu button */
    .mobile-menu-btn {
      display: none;
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      margin-right: 10px;
      padding: 8px;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }

    .mobile-menu-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .mobile-menu-btn:active {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Toggle switch container in the top menu */
    .custom-toggle-wrapper {
      display: flex;
      align-items: center;
      margin-left: 1rem;
      white-space: nowrap;
      gap: 0.5rem;
      max-width: 150px;
      overflow: visible;
    }

    /* Custom Switch */
    .custom-switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 20px;
      margin-right: 8px;
    }

    .custom-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .custom-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 20px;
    }

    .custom-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .custom-slider {
      background-color: var(--primary-color);
    }

    input:checked + .custom-slider:before {
      transform: translateX(20px);
    }

    .custom-label {
      font-size: 0.9rem;
      color: white;
      display: inline-block;
      margin-left: 0;
      font-weight: 500;
    }

    /* CONTENT WRAPPER - Updated for fixed sidebar layout */
    .content-wrapper {
      margin-left: 220px; /* Account for fixed sidebar */
      margin-top: var(--nav-height);
      min-height: calc(100vh - var(--nav-height));
      background-color: var(--body-bg-color);
      position: relative;
      z-index: 1;
    }
    @media screen and (max-width: 767px) {
      .content-wrapper {
        margin-left: 0;
        min-height: calc(100vh - var(--nav-height));
      }
      
      #sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }
      
      #sidebar.active,
      #sidebar.mobile-visible {
        transform: translateX(0);
      }
      
      .mobile-menu-btn {
        display: block !important;
      }
    }

    /* SIDEBAR (MENU) - Updated to match nursery software */
    #sidebar {
      position: fixed;
      top: var(--nav-height);
      left: 0;
      width: 220px;
      height: calc(100vh - var(--nav-height));
      background-color: white;
      overflow-y: auto;
      transition: transform 0.3s ease;
      z-index: 1001; /* Higher than backdrop */
      border-right: 1px solid var(--border-color);
      box-shadow: 2px 0 4px rgba(0, 0, 0, 0.05);
      padding: 0;
      max-height: calc(100vh - var(--nav-height) - 3rem); /* Limit max height */
      overflow-y: auto; /* Add scrolling if needed */
    }

    .sidebar-nav {
      padding: 0;
    }

    .sidebar-menu {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .menu-item {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      transition: all 0.2s ease;
      font-size: 14px;
      color: var(--text-color);
      text-decoration: none;
    }

    .menu-item:hover {
      background-color: #f8f9fa;
      color: var(--primary-color);
    }

    .menu-item.active {
      background-color: var(--table-row-bg);
      color: var(--primary-color);
      font-weight: 600;
      border-left: 3px solid var(--primary-color);
    }

    .menu-item i {
      font-size: 16px;
      margin-right: 12px;
      width: 20px;
      text-align: center;
      color: var(--light-text-color);
    }

    .menu-item.active i,
    .menu-item:hover i {
      color: var(--primary-color);
    }

    .menu-item span {
      flex: 1;
      font-weight: 500;
    }

    /* Submenu styling */
    .submenu-item {
      padding-left: 40px !important;
      font-size: 13px !important;
      background-color: #f8f9fa;
    }

    .submenu-item:hover {
      background-color: #e9ecef;
    }

    .submenu-item.active {
      background-color: var(--table-row-bg);
      border-left: 3px solid var(--primary-color);
    }

    /* Submenu for plan */
    #planSubmenu {
      list-style: none;
      padding-left: 1rem;
      display: none;
    }

    #planSubmenu li {
      padding: 0.5rem;
      cursor: pointer;
      font-size: 12px;
    }

    #planSubmenu li:hover {
      background-color: var(--table-row-hover);
    }

    /* MAIN CONTENT - Updated for new layout */
    main {
      width: 100%;
      padding: 0;
    }

    .page-section {
      padding: 1.5rem;
    }

    .page-section.active {
      display: block;
    }

    .page-section:not(.active) {
      display: none;
    }


    /* Ensure proper layout for all page sections */
    .page-section {
      display: none;
      width: 100%;
      position: relative;
      z-index: 1;
    }

    .page-section.active {
      display: block;
    }

    .page-title {
      margin-bottom: 1.5rem;
      margin-top: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .page-title h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0;
    }

    /* Cards */
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 260px));
      gap: 1rem;
      margin-bottom: 2rem;
      justify-content: start;
    }

    .card {
      background-color: var(--card-bg-color);
      border-radius: 4px;
      padding: 1rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      max-width: 260px;
      width: 100%;
      transition: all 0.3s ease;
    }

    .card h2 {
      font-family: 'Roboto', sans-serif;
      font-weight: 600;
      font-size: 18px;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }

    .card .value {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }

    .card .subtitle {
      font-size: 0.875rem;
      color: var(--light-text-color);
    }

    .btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background-color var(--transition-speed);
    }

    .btn:hover {
      background-color: var(--tertiary-color);
    }

    .btn-secondary {
      background-color: var(--secondary-color);
      color: white;
    }

    .btn-secondary:hover {
      background-color: var(--primary-color);
    }

    /* Table styling to match nursery software */
    .responsive-table th {
      font-weight: 600;
      text-align: left;
      padding: 12px;
      background-color: var(--table-header-bg);
      color: white;
      border-bottom: 2px solid var(--tertiary-color);
    }

    .responsive-table td {
      padding: 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .responsive-table tbody tr:nth-child(even) {
      background-color: var(--table-row-bg);
    }

    .responsive-table tbody tr:hover {
      background-color: var(--table-row-hover);
      transition: background-color 0.2s ease;
    }

    /* Form input styling to match nursery software */
    input[type="text"],
    input[type="email"],
    input[type="number"],
    input[type="password"],
    select,
    textarea {
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 0.6rem;
      font-size: 0.95rem;
      background-color: var(--card-bg-color);
      color: var(--text-color);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="number"]:focus,
    input[type="password"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(156, 175, 63, 0.2);
    }

    input[readonly] {
      background-color: var(--menu-bg-color);
      color: var(--light-text-color);
    }

    /* Badge and status indicator styling */
    .badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      font-weight: 600;
      border-radius: 12px;
      text-align: center;
      white-space: nowrap;
    }

    .badge-primary {
      background-color: var(--primary-color);
      color: white;
    }

    .badge-info {
      background-color: var(--info-color);
      color: white;
    }

    .badge-success {
      background-color: var(--success-color);
      color: white;
    }

    .badge-warning {
      background-color: var(--warning-color);
      color: white;
    }

    /* Card styling improvements */
    .card {
      background-color: var(--card-bg-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: box-shadow 0.2s ease;
    }

    .card:hover {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    /* UniPaas component styling to match nursery software */
    div[data-unipaas] {
      font-family: 'Inter', sans-serif !important;
    }

    /* Style UniPaas buttons to match our theme */
    div[data-unipaas] button,
    div[data-unipaas] [role="button"],
    div[data-unipaas] .btn,
    div[data-unipaas] input[type="submit"],
    div[data-unipaas] input[type="button"] {
      background-color: #9CAF3F !important;
      border-color: #9CAF3F !important;
      color: white !important;
      font-weight: 500 !important;
      transition: all 0.2s ease !important;
    }

    div[data-unipaas] button:hover,
    div[data-unipaas] [role="button"]:hover,
    div[data-unipaas] .btn:hover,
    div[data-unipaas] input[type="submit"]:hover,
    div[data-unipaas] input[type="button"]:hover {
      background-color: #7A8F32 !important;
      border-color: #7A8F32 !important;
    }

    /* Specifically target Get Started and similar primary action buttons */
    div[data-unipaas] button[class*="primary"],
    div[data-unipaas] button[class*="get-started"],
    div[data-unipaas] button[class*="start"],
    div[data-unipaas] .primary-button,
    div[data-unipaas] .get-started-button,
    div[data-unipaas] .start-button {
      background-color: #9CAF3F !important;
      border-color: #9CAF3F !important;
      color: white !important;
    }

    /* Style UniPaas input fields */
    div[data-unipaas] input,
    div[data-unipaas] select {
      border: 1px solid var(--border-color) !important;
      border-radius: 4px !important;
      padding: 0.6rem !important;
      background-color: var(--card-bg-color) !important;
      color: var(--text-color) !important;
    }

    div[data-unipaas] input:focus,
    div[data-unipaas] select:focus {
      border-color: var(--primary-color) !important;
      box-shadow: 0 0 0 2px rgba(156, 175, 63, 0.2) !important;
      outline: none !important;
    }

    /* Style UniPaas tables to match our design - Enhanced specificity */
    div[data-unipaas] table,
    [data-unipaas] table,
    div[data-unipaas] * table {
      border-collapse: collapse !important;
      width: 100% !important;
      background: transparent !important;
    }

    /* Table headers - Multiple selectors for maximum specificity */
    div[data-unipaas] table th,
    [data-unipaas] table th,
    div[data-unipaas] * table th,
    div[data-unipaas] table thead th,
    [data-unipaas] table thead th,
    div[data-unipaas] * thead th {
      background-color: #9CAF3F !important;
      background: #9CAF3F !important;
      color: white !important;
      font-weight: 600 !important;
      padding: 12px !important;
      text-align: left !important;
      border-bottom: 2px solid #7A8F32 !important;
      border: none !important;
    }

    /* Table cells - Enhanced selectors */
    div[data-unipaas] table td,
    [data-unipaas] table td,
    div[data-unipaas] * table td,
    div[data-unipaas] table tbody td,
    [data-unipaas] table tbody td,
    div[data-unipaas] * tbody td {
      padding: 12px !important;
      border-bottom: 1px solid #D1D5DB !important;
      border-left: none !important;
      border-right: none !important;
      border-top: none !important;
    }

    /* Alternating row colors - Multiple selectors with high specificity */
    div[data-unipaas] table tbody tr:nth-child(even),
    [data-unipaas] table tbody tr:nth-child(even),
    div[data-unipaas] * table tbody tr:nth-child(even),
    div[data-unipaas] tbody tr:nth-child(even),
    [data-unipaas] tbody tr:nth-child(even),
    div[data-unipaas] * tbody tr:nth-child(even) {
      background-color: #E8E6D3 !important;
      background: #E8E6D3 !important;
    }

    div[data-unipaas] table tbody tr:nth-child(even) td,
    [data-unipaas] table tbody tr:nth-child(even) td,
    div[data-unipaas] * table tbody tr:nth-child(even) td,
    div[data-unipaas] tbody tr:nth-child(even) td,
    [data-unipaas] tbody tr:nth-child(even) td,
    div[data-unipaas] * tbody tr:nth-child(even) td {
      background-color: #E8E6D3 !important;
      background: #E8E6D3 !important;
    }

    /* Odd rows should be white */
    div[data-unipaas] table tbody tr:nth-child(odd),
    [data-unipaas] table tbody tr:nth-child(odd),
    div[data-unipaas] * table tbody tr:nth-child(odd),
    div[data-unipaas] tbody tr:nth-child(odd),
    [data-unipaas] tbody tr:nth-child(odd),
    div[data-unipaas] * tbody tr:nth-child(odd) {
      background-color: white !important;
      background: white !important;
    }

    div[data-unipaas] table tbody tr:nth-child(odd) td,
    [data-unipaas] table tbody tr:nth-child(odd) td,
    div[data-unipaas] * table tbody tr:nth-child(odd) td,
    div[data-unipaas] tbody tr:nth-child(odd) td,
    [data-unipaas] tbody tr:nth-child(odd) td,
    div[data-unipaas] * tbody tr:nth-child(odd) td {
      background-color: white !important;
      background: white !important;
    }

    /* Hover effects */
    div[data-unipaas] table tbody tr:hover,
    [data-unipaas] table tbody tr:hover,
    div[data-unipaas] * table tbody tr:hover,
    div[data-unipaas] tbody tr:hover,
    [data-unipaas] tbody tr:hover,
    div[data-unipaas] * tbody tr:hover {
      background-color: #DDD9C4 !important;
      background: #DDD9C4 !important;
    }

    div[data-unipaas] table tbody tr:hover td,
    [data-unipaas] table tbody tr:hover td,
    div[data-unipaas] * table tbody tr:hover td,
    div[data-unipaas] tbody tr:hover td,
    [data-unipaas] tbody tr:hover td,
    div[data-unipaas] * tbody tr:hover td {
      background-color: #DDD9C4 !important;
      background: #DDD9C4 !important;
    }

    /* Style UniPaas cards and containers */
    div[data-unipaas] .card,
    div[data-unipaas] [class*="card"] {
      background-color: var(--card-bg-color) !important;
      border: 1px solid var(--border-color) !important;
      border-radius: 8px !important;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
    }

    /* Style UniPaas text elements */
    div[data-unipaas] h1,
    div[data-unipaas] h2,
    div[data-unipaas] h3,
    div[data-unipaas] h4,
    div[data-unipaas] h5,
    div[data-unipaas] h6 {
      color: var(--text-color) !important;
    }

    div[data-unipaas] p,
    div[data-unipaas] span,
    div[data-unipaas] div {
      color: var(--text-color) !important;
    }

    /* Style UniPaas secondary text */
    div[data-unipaas] .text-muted,
    div[data-unipaas] [class*="secondary"],
    div[data-unipaas] small {
      color: var(--light-text-color) !important;
    }

    /* Style UniPaas status badges and indicators */
    div[data-unipaas] .badge,
    div[data-unipaas] [class*="badge"],
    div[data-unipaas] .status,
    div[data-unipaas] [class*="status"] {
      border-radius: 12px !important;
      padding: 0.25rem 0.5rem !important;
      font-size: 0.75rem !important;
      font-weight: 600 !important;
    }

    /* Success status styling */
    div[data-unipaas] .badge-success,
    div[data-unipaas] [class*="success"] {
      background-color: var(--success-color) !important;
      color: white !important;
    }

    /* Warning/Error status styling */
    div[data-unipaas] .badge-warning,
    div[data-unipaas] .badge-error,
    div[data-unipaas] [class*="warning"],
    div[data-unipaas] [class*="error"] {
      background-color: var(--warning-color) !important;
      color: white !important;
    }

    /* Info status styling */
    div[data-unipaas] .badge-info,
    div[data-unipaas] [class*="info"] {
      background-color: var(--info-color) !important;
      color: white !important;
    }

    /* Primary status styling */
    div[data-unipaas] .badge-primary,
    div[data-unipaas] [class*="primary"] {
      background-color: var(--primary-color) !important;
      color: white !important;
    }

    /* Style UniPaas loading states */
    div[data-unipaas] .spinner,
    div[data-unipaas] [class*="loading"],
    div[data-unipaas] [class*="spinner"] {
      border-color: var(--primary-color) !important;
    }

    /* Override any conflicting styles for better integration */
    div[data-unipaas] * {
      box-sizing: border-box !important;
    }

    /* Target the specific UniPaas button class from the screenshot */
    .unipaas-button-events button,
    div[data-unipaas] .unipaas-button-events button,
    [data-unipaas] .unipaas-button-events button {
      background-color: #9CAF3F !important;
      background: #9CAF3F !important;
      border-color: #9CAF3F !important;
      border: 1px solid #9CAF3F !important;
      color: white !important;
      box-shadow: 0px 4px 19.1px 0px rgba(156, 175, 63, 0.08) !important;
    }

    .unipaas-button-events button:hover,
    div[data-unipaas] .unipaas-button-events button:hover,
    [data-unipaas] .unipaas-button-events button:hover {
      background-color: #7A8F32 !important;
      background: #7A8F32 !important;
      border-color: #7A8F32 !important;
      border: 1px solid #7A8F32 !important;
    }

    /* Balance component container */
    .balance-container {
      width: 100%;
      max-width: 550px;
      margin-top: 1rem;
      background: var(--card-bg-color);
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      border: 1px solid var(--border-color);
      position: relative;
      overflow: visible;
      min-height: 200px;
      transition: height 0.3s ease;
      height: fit-content;
      padding: 0;
      display: flex;
      flex-direction: column;
      will-change: width, height; /* Optimize for animations */
    }

    /* Balance container with content loaded */
    .balance-container.content-loaded {
      min-height: 0; /* Remove minimum height once content is loaded */
      height: auto !important; /* Ensure height adapts to content */
    }

    /* Balance container child elements */
    .balance-container > div {
      width: 100% !important;
      margin: 0 !important;
      padding: 0 !important;
    }

    /* Balance loading spinner */
    .balance-loading-spinner {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease;
    }

    .balance-loading-spinner.visible {
      opacity: 1;
      visibility: visible;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: var(--secondary-color);
      border-radius: 50%;
      margin: 0 auto 15px;
      animation: spin 1s linear infinite;
    }

    .spinner-text {
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      font-weight: 500;
      color: var(--primary-color);
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Balance component loading state */
    .balance-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.7);
      z-index: 1;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease;
    }

    .balance-container.loading::before {
      opacity: 1;
      visibility: visible;
    }

    /* Modal styles */
    .modal-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .modal-backdrop.active {
      display: flex;
    }

    .modal-content {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      width: 100%;
      max-width: 600px;
    }
    
    /* Success icon for payment success */
    .success-icon {
      position: relative;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background-color: var(--success-color);
      margin: 0 auto;
      animation: scaleIn 0.3s ease-out;
    }
    
    .checkmark {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(45deg);
      height: 25px;
      width: 12px;
      border-bottom: 5px solid white;
      border-right: 5px solid white;
      animation: checkmarkDraw 0.4s ease-out 0.2s forwards;
      opacity: 0;
    }
    
    @keyframes scaleIn {
      0% {
        transform: scale(0);
      }
      80% {
        transform: scale(1.1);
      }
      100% {
        transform: scale(1);
      }
    }
    
    @keyframes checkmarkDraw {
      0% {
        height: 0;
        width: 0;
        opacity: 0;
      }
      100% {
        height: 25px;
        width: 12px;
        opacity: 1;
      }
    }
    
    /* Payment tabs styling */
    .payment-tab {
      transition: all 0.3s ease;
    }
    
    .payment-tab:hover {
      background-color: var(--table-row-hover);
    }
    
    .payment-tab.active {
      color: var(--primary-color);
    }
    
    /* Mobile styles for payment modal */
    @media screen and (max-width: 767px) {
      .payment-tabs {
        display: none !important;
      }
      
      .payment-method-selector {
        display: block !important;
      }
      
      .modal-content {
        width: 95%;
        max-height: 80vh;
      }
      
      /* Bottom sheet mobile styles */
      .bottom-sheet {
        padding-bottom: 30px;
      }
      
      .bottom-sheet-content {
        max-height: 60vh;
      }
      
      .bottom-sheet-option {
        padding: 18px 20px;
      }
      
      .bottom-sheet-option i {
        font-size: 22px;
      }
    }

    /* Ensure the onboarding component container has sufficient height */
    #onboarding {
      min-height: 500px;
      width: 100%;
      position: relative;
      overflow: visible;
    }

    /* Make sure any iframes within the onboarding component are properly sized */
    #onboarding iframe {
      width: 100%;
      min-height: 500px;
      border: none;
    }

    /* Properly position the close button so it doesn't interfere with the component */
    #onboardingModal .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 2500;
    }

    .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--menu-bg-color);
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      font-size: 18px;
      line-height: 30px;
      text-align: center;
      color: var(--light-text-color);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
    
    .close-btn:hover {
      background: var(--menu-bg-color);
      color: var(--text-color);
    }

    /* Pay Portal container */
    .table-container {
      background-color: var(--card-bg-color);
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      margin-bottom: 1.5rem;
    }

    #pay_portal {
      width: 100%;
      min-height: 500px;
      background: var(--card-bg-color);
    }

    #refreshPayPortalBtn {
      padding: 0.3rem 0.6rem;
      background-color: var(--menu-bg-color);
      color: var(--text-color);
      display: flex;
      align-items: center;
      gap: 5px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      margin-left: 1rem;
      font-size: 0.9rem;
    }

    /* Improve modal responsiveness */
    #onboardingModal .modal-content {
      position: relative;
      width: 90%;
      max-width: 650px;
      max-height: 75vh; /* Reduced from 80vh to make it less tall */
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding: 0;
      margin: auto;
      border-radius: 12px; /* Increased rounded corners */
      box-shadow: 0 5px 25px rgba(0, 0, 0, 0.18);
    }

    #onboardingModal #onboarding {
      flex: 1;
      width: 100%;
      height: 100%;
      min-height: 480px; /* Reduced from 500px */
      max-height: calc(75vh - 20px); /* Account for padding */
      overflow: auto; /* Changed from visible to allow scrolling if needed */
      -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
      border-radius: 12px; /* Matching border radius */
    }

    /* Ensure iframe within onboarding has proper dimensions */
    #onboardingModal #onboarding iframe {
      width: 100% !important;
      height: 100% !important;
      min-height: 480px;
      max-height: calc(75vh - 20px);
      border: none;
      display: block;
      border-radius: 12px; /* Matching border radius */
    }
    
    /* Restore close button styling */
    #onboardingModal .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 2500;
      width: 36px;
      height: 36px;
      font-size: 20px;
      background-color: rgba(255, 255, 255, 0.9);
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
    }

    /* Mobile styles */
    @media screen and (max-width: 767px) {
      .mobile-menu-btn {
        display: inline-block;
      }
      
      #sidebar {
        position: fixed;
        left: -250px; /* Increased to fully hide sidebar */
        top: var(--nav-height);
        height: calc(100vh - var(--nav-height));
        max-height: calc(100vh - var(--nav-height));
        transition: left 0.3s ease;
        z-index: 1001; /* Higher z-index to ensure it's above content */
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        width: 231px;
        overflow-y: auto;
        border-radius: 0 8px 8px 0; /* Only round right corners */
        margin: 0; /* Remove margin that might cause issues */
        background-color: var(--menu-bg-color);
      }
      
      #sidebar.mobile-visible {
        left: 0; /* Slide in from left edge */
      }
      
      .content-wrapper {
        margin-left: 0;
        width: 100%;
        padding: 1rem;
        flex-direction: column;
        position: relative;
        z-index: 1; /* Ensure content is below sidebar */
      }
      
      main {
        width: 100%;
        padding: 0;
        position: relative;
        z-index: 1;
      }
      
      .sidebar-backdrop {
        display: none;
        position: fixed;
        top: var(--nav-height);
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000; /* Below sidebar but above content */
      }
      
      .sidebar-backdrop.active {
        display: block;
      }
      
      .balance-container {
        width: 100%;
        max-width: 100%;
        min-height: 0;
        height: auto !important;
      }
      
      .balance-container.content-loaded {
        min-height: 0;
        height: auto !important;
      }

      #pay_portal {
        min-height: 550px;
      }

      .table-container {
        padding: 0.75rem !important;
      }

      .cards {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        justify-content: center;
      }

      .card {
        max-width: 100%;
      }

      /* Enhanced Mobile modal styles */
      #onboardingModal .modal-content {
        width: 95%;
        max-width: none;
        max-height: 75vh;
        margin: 0 auto;
        border-radius: 16px;
      }

      #onboardingModal #onboarding {
        min-height: 430px;
        max-height: calc(75vh - 20px);
        padding: 0;
        overflow-y: auto;
        border-radius: 16px;
      }

      #onboardingModal iframe {
        min-height: 430px;
        max-height: calc(75vh - 20px);
        height: 100%;
        width: 100%;
        border-radius: 16px;
      }
      
      #onboardingModal .close-btn {
        width: 40px;
        height: 40px;
        font-size: 24px;
        top: 5px;
        right: 5px;
      }
      
      /* Improve touch target sizes for mobile */
      button, 
      input[type="button"], 
      input[type="submit"] {
        min-height: 44px;
        min-width: 44px;
      }
      
      /* Responsive table styles for invoices on mobile */
      #salesInvoices-section .table-container {
        padding: 0.75rem !important;
        margin-bottom: 1.5rem;
      }
      
      #salesInvoices-section table {
        min-width: auto !important;
        width: 100%;
      }
      
      #salesInvoices-section table thead {
        display: none;
      }
      
      #salesInvoices-section table tbody tr {
        display: block;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        margin-bottom: 1rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        padding: 0.5rem;
        background-color: white;
      }
      
      #salesInvoices-section table td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: none !important;
        padding: 8px 12px !important;
        text-align: right;
      }
      
      #salesInvoices-section table td::before {
        content: attr(data-label);
        font-weight: 600;
        text-align: left;
        margin-right: 1rem;
        flex-shrink: 0;
        min-width: 100px;
      }
      
      #salesInvoices-section table td:last-child {
        justify-content: space-between;
        padding-top: 12px !important;
        border-top: 1px solid var(--border-color) !important;
        margin-top: 0.5rem;
      }
      
      #salesInvoices-section table td:last-child::before {
        display: inline-block;
        min-width: 100px;
      }
      
      #salesInvoices-section table td button {
        margin-left: auto;
        display: inline-block;
        min-width: 100px;
        text-align: center;
      }
      
      #salesInvoices-section table td:last-child span {
        margin-left: auto;
        min-width: 100px;
        text-align: center;
        display: inline-block;
      }
    }

    /* Small mobile styles */
    @media screen and (max-width: 480px) {
      .balance-container {
        height: auto !important; /* Override any inline styles */
        min-height: 400px;
      }
      
      /* Fully expand modal on very small screens */
      #onboardingModal .modal-content {
        width: 95%;
        height: auto;
        max-height: 85vh; /* Still taller on very small screens for better visibility */
        border-radius: 14px; /* Maintain some rounded corners even on small screens */
        padding: 0;
        margin: 0 auto;
      }
      
      #onboardingModal #onboarding {
        min-height: calc(85vh - 50px); /* Account for close button */
        max-height: calc(85vh - 50px);
        overflow-y: auto;
        border-radius: 14px;
      }
      
      #onboardingModal #onboarding iframe {
        min-height: calc(85vh - 50px);
        max-height: calc(85vh - 50px);
        border-radius: 14px;
      }

      .pay-portal-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      #refreshPayPortalBtn {
        align-self: flex-end;
      }

      .content-wrapper {
        padding: 0.75rem;
      }

      .page-title h1 {
        font-size: 1.3rem;
      }

      .cards {
        grid-template-columns: 1fr;
      }

      /* Position close button more prominently on very small screens */
      #onboardingModal .close-btn {
        top: 5px;
        right: 5px;
        width: 44px;
        height: 44px;
        font-size: 26px;
        background-color: rgba(255, 255, 255, 0.95);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      }
    }

    /* Tablet layout */
    @media (min-width: 768px) and (max-width: 1024px) {
      .balance-container {
        width: 100%;
        max-width: 550px;
        height: 500px;
      }

      .content-wrapper {
        padding: 1.25rem;
      }

      .cards {
        grid-template-columns: repeat(auto-fit, minmax(220px, 260px));
      }
    }

    /* Medium screens */
    @media (min-width: 1025px) and (max-width: 1366px) {
      .balance-container {
        max-width: 550px;
      }
      
      .cards {
        grid-template-columns: repeat(auto-fit, minmax(220px, 260px));
      }
    }

    /* Large screens */
    @media (min-width: 1367px) {
      .balance-container {
        max-width: 550px;
      }
      
      .cards {
        grid-template-columns: repeat(auto-fit, minmax(220px, 260px));
        max-width: 600px;
      }
    }

    /* Loading overlay styles */
    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      z-index: 2100;
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    #loadingOverlay .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--secondary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    #loadingOverlay p {
      margin-top: 15px;
      font-weight: 500;
      font-size: 16px;
      color: var(--primary-color);
    }

    /* Ensure balance component adapts to content properly */
    .balance-container.content-loaded {
      height: auto !important; /* Ensure height adapts to content */
      transition: height 0.3s ease;
    }

    /* Make buttons in components more touch-friendly */
    .balance-container button,
    #pay_portal button {
      min-height: 40px;
      min-width: 80px;
      padding: 8px 16px;
      font-size: 14px;
      border-radius: 4px;
      margin: 4px 0;
      transition: background-color 0.2s ease;
    }

    @media screen and (max-width: 767px) {
      /* Larger loading spinner for mobile */
      #loadingOverlay .spinner {
        width: 60px;
        height: 60px;
        border-width: 6px;
      }

      #loadingOverlay p {
        font-size: 18px;
        margin-top: 20px;
      }
      
      /* Adjust balance component for better viewing on mobile */
      .balance-container {
        height: auto !important;
        min-height: 320px;
        padding: 0;
        margin: 0 auto;
        border-radius: 8px;
        overflow: hidden;
      }
      
      /* Ensure buttons are large enough for touch on mobile */
      .balance-container button,
      #pay_portal button {
        min-height: 44px;
        min-width: 100px;
        padding: 10px 20px;
        font-size: 16px;
      }
    }
    
    /* Small mobile styles */

    /* Card digits visibility styles */
    .card-digits {
      font-family: monospace;
    }

    .card-digits.hidden {
      visibility: hidden;
    }

    .card-digits.visible {
      visibility: visible;
    }

    .show-digits-btn {
      background: none;
      border: none;
      cursor: pointer;
      margin-left: 5px;
      color: var(--primary-color);
      font-size: 16px;
    }

    .show-digits-btn:hover {
      color: var(--secondary-color);
    }

    .customer-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1rem;
    }

    .customer-card {
      display: flex;
      flex-direction: column;
      background-color: var(--card-bg-color);
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      padding: 0.8rem;
      position: relative;
      max-width: 600px;
    }

    .customer-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 0.5rem;
    }

    .customer-details {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5rem;
      padding-top: 0.4rem;
      border-top: 1px solid var(--border-color);
    }

    .customer-card-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-grow: 1;
      margin-right: 0.5rem;
    }

    .card-type {
      width: 40px;
      height: 25px;
      background-position: center;
      background-repeat: no-repeat;
      background-size: contain;
    }

    .visa-card {
      background-image: url('https://img.icons8.com/color/48/000000/visa.png');
    }

    .mastercard-card {
      background-image: url('https://img.icons8.com/color/48/000000/mastercard.png');
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--menu-bg-color);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-color);
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.9rem;
    }

    .customer-info {
      flex: 1;
    }

    .customer-name {
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 2px;
    }

    .customer-email {
      font-size: 0.9rem;
      color: var(--light-text-color);
    }

    .customer-action-btn {
      padding: 0.4rem 0.6rem;
      background-color: var(--secondary-color);
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: background-color 0.2s;
      margin-right: 0.3rem;
    }

    .customer-action-btn:last-child {
      margin-right: 0;
    }

    .customer-action-btn:hover {
      background-color: var(--primary-color);
      color: white;
    }

    /* Mobile styles for customer cards */
    @media screen and (max-width: 767px) {
      .customer-card {
        max-width: 100%;
      }
      
      .customer-details {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .customer-card-info {
        margin-bottom: 0.5rem;
        width: 100%;
      }
      
      .customer-action-btn {
        width: 100%;
        margin-right: 0;
        margin-bottom: 0.5rem;
        text-align: center;
      }
    }

    /* Store products styles */
    .store-container {
      margin-top: 1rem;
    }

    .store-products {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
    }

    .store-product-card {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 0.5rem;
      background-color: var(--card-bg-color);
      border-radius: 8px;
      padding: 1.25rem;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .store-product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .product-image-placeholder {
      width: 100%;
      height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 0.5rem;
    }

    .product-image-placeholder img {
      width: 60px;
      height: 60px;
      transition: transform 0.2s ease;
    }

    .store-product-card:hover .product-image-placeholder img {
      transform: scale(1.1);
    }

    .store-product-card .product-title {
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 0.25rem;
    }

    .product-stock {
      font-size: 0.9rem;
      color: var(--light-text-color);
      margin-bottom: 0.25rem;
    }

    .product-price {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }

    .add-to-cart-btn {
      margin-top: auto;
      width: 100%;
      padding: 0.75rem;
      font-weight: 600;
      transition: background-color 0.2s ease;
    }

    .add-to-cart-btn:hover {
      background-color: #00a895;
    }

    /* Mobile responsiveness for store */
    @media screen and (max-width: 767px) {
      .store-products {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1rem;
      }
      
      .store-product-card {
        padding: 1rem;
      }
      
      .product-image-placeholder {
        height: 80px;
      }
      
      .store-product-card .product-title {
        font-size: 1rem;
      }
      
      .product-price {
        font-size: 1.1rem;
      }
      
      .add-to-cart-btn {
        padding: 0.6rem;
        font-size: 0.9rem;
      }
    }

    /* Small mobile screens */
    @media screen and (max-width: 480px) {
      .store-products {
        grid-template-columns: 1fr;
      }
    }

    /* Bottom sheet styles */
    .bottom-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: white;
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
      box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.1);
      transform: translateY(100%);
      transition: transform 0.3s ease;
      z-index: 3000;
      padding-bottom: env(safe-area-inset-bottom, 20px);
      display: none; /* Hide on desktop by default */
    }

    .bottom-sheet.active {
      transform: translateY(0);
    }

    .bottom-sheet-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 2999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease;
      display: none; /* Hide on desktop by default */
    }

    .bottom-sheet-backdrop.active {
      opacity: 1;
      visibility: visible;
    }

    /* Only show bottom sheet components on mobile */
    @media screen and (max-width: 767px) {
      .bottom-sheet, .bottom-sheet-backdrop {
        display: block;
      }
    }

    .bottom-sheet-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid #eee;
    }

    .bottom-sheet-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--primary-color);
      margin: 0;
    }

    .bottom-sheet-content {
      max-height: 50vh;
      overflow-y: auto;
    }

    .bottom-sheet-option {
      display: flex;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
    }

    .bottom-sheet-option:last-child {
      border-bottom: none;
    }

    .bottom-sheet-option:active {
      background-color: var(--table-row-hover);
    }

    .bottom-sheet-option i {
      font-size: 20px;
      margin-right: 16px;
      color: var(--light-text-color);
    }

    .bottom-sheet-option-text {
      font-size: 16px;
      font-weight: 500;
    }

    .bottom-sheet-option.selected {
      color: var(--secondary-color);
    }

    .bottom-sheet-option.selected i {
      color: var(--secondary-color);
    }

    .bottom-sheet-indicator {
      width: 40px;
      height: 4px;
      background-color: #ddd;
      border-radius: 4px;
      margin: 10px auto;
    }

    @keyframes scaleIn {
      0% {
        transform: scale(0);
      }
      80% {
        transform: scale(1.1);
      }
      100% {
        transform: scale(1);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Success modal specific styles */
    #successModal .modal-content {
      animation: fadeIn 0.3s ease-out, slideUp 0.3s ease-out;
    }

    #successModal .success-icon {
      animation: scaleIn 0.5s ease-out;
    }

    #successModal h2 {
      animation: fadeIn 0.5s ease-out 0.2s forwards;
      opacity: 0;
      animation-fill-mode: forwards;
    }

    #successModal p {
      animation: fadeIn 0.5s ease-out 0.3s forwards;
      opacity: 0;
      animation-fill-mode: forwards;
    }

    #successModal button {
      animation: fadeIn 0.5s ease-out 0.4s forwards;
      opacity: 0;
      animation-fill-mode: forwards;
    }

    #successModal button:hover {
      background-color: #00a895;
    }

    /* Add these styles to fix mobile floating modal */
    @media screen and (max-width: 767px) {
      .floating-modal {
        padding: 0 !important;
      }
      
      .floating-modal-content {
        width: 100% !important;
        height: 100% !important;
        max-width: 100% !important;
        max-height: 100% !important;
        border-radius: 0 !important;
      }
      
      .floating-close-btn {
        top: 15px !important;
        right: 15px !important;
        width: 44px !important;
        height: 44px !important;
        font-size: 22px !important;
        background: rgba(0,0,0,0.7) !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important;
      }
    }

    /* Dashboard section with background image */
    #dashboard-section {
      position: relative;
      z-index: 1;
    }
    
    /* Remove dashboard-specific background */
    #dashboard-section::before {
      background-image: none;
    }
    
    /* Add background to the main page container */
    .content-wrapper {
      position: relative;
      z-index: 1;
      background: none;
    }
    .content-wrapper::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: url('647762eb3b0c833332e2b12e_LST-gym.png');
      background-size: cover;
      background-position: center;
      opacity: 0.15;
      z-index: -1;
      border-radius: 8px;
      pointer-events: none;
    }
    
    /* Ensure children of .content-wrapper are positioned above the background */
    .content-wrapper > * {
      position: relative;
      z-index: 2;
    }
    
    #dashboard-section .page-title h1 {
      color: var(--primary-color);
      font-weight: 700;
      text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
    }

    /* Additional nursery theme styling for UniPaas components */
    /* Override UniPaas component styling to match nursery theme */
    div[data-unipaas] {
      border-radius: 8px !important;
      font-family: 'Inter', sans-serif !important;
    }

    div[data-unipaas] button {
      background-color: var(--primary-color) !important;
      border-color: var(--primary-color) !important;
      border-radius: 6px !important;
      font-family: 'Inter', sans-serif !important;
      transition: all 0.3s ease !important;
    }

    div[data-unipaas] button:hover {
      background-color: var(--secondary-color) !important;
      border-color: var(--secondary-color) !important;
    }

    div[data-unipaas] input {
      border-radius: 6px !important;
      border-color: var(--menu-bg-color) !important;
      font-family: 'Inter', sans-serif !important;
    }

    div[data-unipaas] input:focus {
      border-color: var(--primary-color) !important;
      box-shadow: 0 0 0 2px rgba(106, 176, 76, 0.2) !important;
    }

    /* Enhanced mobile layout fixes */
    @media screen and (max-width: 767px) {
      /* Ensure main content is properly positioned */
      main {
        width: 100%;
        max-width: 100%;
        overflow-x: hidden;
        position: relative;
      }
      
      /* Fix any potential layout issues with page sections */
      .page-section {
        width: 100%;
        max-width: 100%;
        overflow-x: hidden;
        padding: 0;
        margin: 0;
      }
      
      /* Ensure customer lists don't cause horizontal scroll */
      .customer-list {
        width: 100%;
        max-width: 100%;
        overflow-x: hidden;
      }
      
      .customer-card {
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
      }
      
      /* Fix page title spacing on mobile */
      .page-title {
        margin-bottom: 1rem;
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      
      .page-title h1 {
        font-size: 1.25rem;
        margin-bottom: 0.5rem;
      }
      
      /* Ensure buttons in page titles work properly on mobile */
      .page-title .btn {
        width: auto;
        min-width: 120px;
      }
    }

    /* Fix any potential content overflow issues */
    * {
      box-sizing: border-box;
    }

    html, body {
      overflow-x: hidden;
      width: 100%;
    }
  </style>
</head>
<body>
  <!-- TOP NAVIGATION -->
  <header class="top-nav">
    <div class="nav-left">
      <button id="mobile-menu-toggle" class="mobile-menu-btn">
        <i class="fa-solid fa-bars"></i>
      </button>
      <div class="nursery-selector">
        <i class="fa-solid fa-baby" style="font-size: 18px; margin-right: 8px; color: white;"></i>
        <select class="nursery-dropdown">
          <option value="little-green-elephants">Little Green Elephants</option>
        </select>
        <i class="fa-solid fa-chevron-down" style="margin-left: 5px; font-size: 12px;"></i>
      </div>
    </div>
    
    <nav class="top-menu">
      <div class="nav-links">
        <span class="nav-link">Dashboard</span>
        <span class="nav-link">Company Dashboard</span>
      </div>
      
      <div class="user-controls">
        <!-- Toggle Button for HIM Vendor -->
        <div class="custom-toggle-wrapper">
          <label class="custom-switch">
            <input id="himToggle" onchange="toggleHIMVendor(this)" type="checkbox" />
            <span class="custom-slider"></span>
          </label>
          <span class="custom-label">Setup</span>
        </div>
        
        <div class="notification-badge">
          <i class="fa-solid fa-bell"></i>
          <span class="badge-count">9</span>
        </div>
        
        <div class="user-menu">
          <i class="fa-solid fa-cog"></i>
        </div>
        
        <div class="user-avatar">
          <span>SA</span>
        </div>
      </div>
    </nav>
  </header>

  <!-- CONTENT WRAPPER -->
  <div class="content-wrapper">
    <!-- Mobile sidebar backdrop -->
    <div class="sidebar-backdrop" id="sidebar-backdrop"></div>
    
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <nav class="sidebar-nav">
        <ul class="sidebar-menu">
          <li class="menu-item active" onclick="showTab('dashboard')">
            <i class="fa-solid fa-house"></i>
            <span>Dashboard</span>
          </li>
          <li class="menu-item" onclick="showTab('parents')">
            <i class="fa-solid fa-users"></i>
            <span>Parents</span>
          </li>
          <li class="menu-item" onclick="showTab('bookings')">
            <i class="fa-solid fa-calendar-check"></i>
            <span>Bookings</span>
          </li>
          <li class="menu-item" onclick="showTab('activities')">
            <i class="fa-solid fa-gamepad2"></i>
            <span>Activities</span>
          </li>
          <li class="menu-item" onclick="showTab('payments')">
            <i class="fa-solid fa-credit-card"></i>
            <span>Payments</span>
          </li>
          <li class="menu-item" onclick="togglePlanSubmenu(event)">
            <i class="fa-solid fa-layer-group"></i>
            <span>Programs</span>
          </li>
          <ul id="planSubmenu" style="list-style: none; padding-left: 2rem; display: none;">
            <li class="menu-item submenu-item" onclick="showTab('createPlan')">
              <span>Create Programs</span>
            </li>
            <li class="menu-item submenu-item" onclick="showTab('managePlan')">
              <span>Manage Programs</span>
            </li>
          </ul>
          <li class="menu-item" onclick="showTab('salesInvoices')">
            <i class="fa-solid fa-file-invoice-dollar"></i>
            <span>Invoices</span>
          </li>
          <li class="menu-item" onclick="showTab('staff')">
            <i class="fa-solid fa-chalkboard-teacher"></i>
            <span>Staff</span>
          </li>
          <li class="menu-item" onclick="showTab('settings')">
            <i class="fa-solid fa-gear"></i>
            <span>Settings</span>
          </li>
        </ul>
      </nav>
    </aside>

    <!-- MAIN CONTENT -->
    <main>
      <!-- Dashboard Section -->
      <div class="page-section active" id="dashboard-section">
        <div class="page-title">
          <h1>Welcome to NurseryCare</h1>
          <p style="color: var(--light-text-color); margin-top: 0.5rem;">Streamline your nursery operations with automated bookings, payments, and childcare management</p>
        </div>
        <div class="cards">
          <div class="card">
            <h2>Children Enrolled</h2>
            <p class="value" style="color: var(--primary-color);">124</p>
            <p class="subtitle">Active registrations</p>
          </div>
          <div class="card">
            <h2>Today's Bookings</h2>
            <p class="value" style="color: var(--success-color);">89</p>
            <p class="subtitle">Sessions booked today</p>
          </div>
          <div class="card">
            <h2>Staff on Duty</h2>
            <p class="value" style="color: var(--accent-color);">12</p>
            <p class="subtitle">Current shift</p>
          </div>
          <div class="card">
            <h2>Outstanding Payments</h2>
            <p class="value" style="color: var(--warning-color);">£2,340</p>
            <p class="subtitle"><button class="btn" style="font-weight: 700;" onclick="dashboardCollectPayment()">Collect Payment</button></p>
          </div>
        </div>
        <div id="balance-dashboard" class="balance-container">
          <div class="balance-loading-spinner">
            <div class="spinner"></div>
            <div class="spinner-text">Loading Payment Portal</div>
          </div>
        </div>
      </div>

      <!-- Parents Section -->
      <div class="page-section" id="parents-section">
        <div class="page-title">
          <h1>Parents</h1>
        </div>
        <!-- Parents List -->
        <div class="customer-list">
          <!-- Parent 1 -->
          <div class="customer-card">
            <div class="customer-header">
              <div class="avatar">SJ</div>
              <div class="customer-info">
                <div class="customer-name">
                  Sarah Johnson
                </div>
                <div class="customer-email">sarah.johnson@gmail.com • +44 7891 234567</div>
              </div>
            </div>
            <div class="customer-details">
              <div class="customer-card-info">
                <div class="card-type visa-card"></div>
                <span>Visa ending in <span class="card-digits hidden">4321</span><span class="asterisks">****</span></span>
                <button class="show-digits-btn" onclick="toggleCardDigits(this)" title="Show/hide card digits">
                  <i class="fa-solid fa-eye"></i>
                </button>
              </div>
              <button class="customer-action-btn" onclick="updateCardPayment('Sarah Johnson', 'sarah.johnson@gmail.com')">Update Payment</button>
              <button class="customer-action-btn" onclick="openSendMandateModal('Sarah Johnson', 'sarah.johnson@gmail.com')">Send Message</button>
            </div>
          </div>
          <!-- Parent 2 -->
          <div class="customer-card">
            <div class="customer-header">
              <div class="avatar">MW</div>
              <div class="customer-info">
                <div class="customer-name">
                  Michael Williams
                </div>
                <div class="customer-email">michael.williams@outlook.com • +44 7892 345678</div>
              </div>
            </div>
            <div class="customer-details">
              <div class="customer-card-info">
                <div class="card-type mastercard-card"></div>
                <span>Mastercard ending in <span class="card-digits hidden">7658</span><span class="asterisks">****</span></span>
                <button class="show-digits-btn" onclick="toggleCardDigits(this)" title="Show/hide card digits">
                  <i class="fa-solid fa-eye"></i>
                </button>
              </div>
              <button class="customer-action-btn" onclick="updateCardPayment('Michael Williams', 'michael.williams@outlook.com')">Update Payment</button>
              <button class="customer-action-btn" onclick="openSendMandateModal('Michael Williams', 'michael.williams@outlook.com')">Send Message</button>
            </div>
          </div>
          <!-- Parent 3 -->
          <div class="customer-card">
            <div class="customer-header">
              <div class="avatar">LD</div>
              <div class="customer-info">
                <div class="customer-name">
                  Lisa Davis
                </div>
                <div class="customer-email">lisa.davis@yahoo.com • +44 7893 456789</div>
              </div>
            </div>
            <div class="customer-details">
              <div class="customer-card-info">
                <div class="card-type visa-card"></div>
                <span>Visa ending in <span class="card-digits hidden">9012</span><span class="asterisks">****</span></span>
                <button class="show-digits-btn" onclick="toggleCardDigits(this)" title="Show/hide card digits">
                  <i class="fa-solid fa-eye"></i>
                </button>
              </div>
              <button class="customer-action-btn" onclick="updateCardPayment('Lisa Davis', 'lisa.davis@yahoo.com')">Update Payment</button>
              <button class="customer-action-btn" onclick="openSendMandateModal('Lisa Davis', 'lisa.davis@yahoo.com')">Send Message</button>
            </div>
          </div>
          <!-- Parent 4 -->
          <div class="customer-card">
            <div class="customer-header">
              <div class="avatar">RP</div>
              <div class="customer-info">
                <div class="customer-name">
                  Robert Parker
                </div>
                <div class="customer-email">robert.parker@gmail.com • +44 7894 567890</div>
              </div>
            </div>
            <div class="customer-details">
              <div class="customer-card-info">
                <div class="card-type mastercard-card"></div>
                <span>Mastercard ending in <span class="card-digits hidden">3456</span><span class="asterisks">****</span></span>
                <button class="show-digits-btn" onclick="toggleCardDigits(this)" title="Show/hide card digits">
                  <i class="fa-solid fa-eye"></i>
                </button>
              </div>
              <button class="customer-action-btn" onclick="updateCardPayment('Robert Parker', 'robert.parker@gmail.com')">Update Payment</button>
              <button class="customer-action-btn" onclick="openSendMandateModal('Robert Parker', 'robert.parker@gmail.com')">Send Message</button>
            </div>
          </div>
          <!-- Parent 5 -->
          <div class="customer-card">
            <div class="customer-header">
              <div class="avatar">AM</div>
              <div class="customer-info">
                <div class="customer-name">
                  Amanda Miller
                </div>
                <div class="customer-email">amanda.miller@hotmail.com • +44 7895 678901</div>
              </div>
            </div>
            <div class="customer-details">
              <div class="customer-card-info">
                <div class="card-type visa-card"></div>
                <span>Visa ending in <span class="card-digits hidden">7890</span><span class="asterisks">****</span></span>
                <button class="show-digits-btn" onclick="toggleCardDigits(this)" title="Show/hide card digits">
                  <i class="fa-solid fa-eye"></i>
                </button>
              </div>
              <button class="customer-action-btn" onclick="updateCardPayment('Amanda Miller', 'amanda.miller@hotmail.com')">Update Payment</button>
              <button class="customer-action-btn" onclick="openSendMandateModal('Amanda Miller', 'amanda.miller@hotmail.com')">Send Message</button>
            </div>
          </div>
          <!-- Parent 6 -->
          <div class="customer-card">
            <div class="customer-header">
              <div class="avatar">DT</div>
              <div class="customer-info">
                <div class="customer-name">
                  David Thompson
                </div>
                <div class="customer-email">david.thompson@icloud.com • +44 7896 789012</div>
              </div>
            </div>
            <div class="customer-details">
              <div class="customer-card-info">
                <div class="card-type mastercard-card"></div>
                <span>Mastercard ending in <span class="card-digits hidden">2345</span><span class="asterisks">****</span></span>
                <button class="show-digits-btn" onclick="toggleCardDigits(this)" title="Show/hide card digits">
                  <i class="fa-solid fa-eye"></i>
                </button>
              </div>
              <button class="customer-action-btn" onclick="updateCardPayment('David Thompson', 'david.thompson@icloud.com')">Update Payment</button>
              <button class="customer-action-btn" onclick="openSendMandateModal('David Thompson', 'david.thompson@icloud.com')">Send Message</button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="page-section" id="members-section">
        <div class="page-title">
          <h1>Customers</h1>
        </div>
        <!-- Customer List -->
        <div class="customer-list">
          <!-- Customer 1 -->
          <div class="customer-card">
            <div class="customer-header">
              <div class="avatar">OK</div>
              <div class="customer-info">
                <div class="customer-name">
                  Oded Kovach
                </div>
                <div class="customer-email">Oded.Kovach@gmail.com</div>
              </div>
            </div>
            <div class="customer-details">
              <div class="customer-card-info">
                <div class="card-type visa-card"></div>
                <span>Visa ending in <span class="card-digits hidden">4321</span><span class="asterisks">****</span></span>
                <button class="show-digits-btn" onclick="toggleCardDigits(this)" title="Show/hide card digits">
                  <i class="fa-solid fa-eye"></i>
                </button>
              </div>
              <button class="customer-action-btn" onclick="updateCardPayment('Oded Kovach', 'Oded.Kovach@gmail.com')">Update Card</button>
              <button class="customer-action-btn" onclick="openSendMandateModal('Oded Kovach', 'Oded.Kovach@gmail.com')">Send Mandate</button>
            </div>
          </div>
          <!-- Customer 2 -->
          <div class="customer-card">
            <div class="customer-header">
              <div class="avatar">JM</div>
              <div class="customer-info">
                <div class="customer-name">
                  John Mitch
                </div>
                <div class="customer-email">john.mitch@gmail.com</div>
              </div>
            </div>
            <div class="customer-details">
              <div class="customer-card-info">
                <div class="card-type mastercard-card"></div>
                <span>Mastercard ending in <span class="card-digits hidden">5032</span><span class="asterisks">****</span></span>
                <button class="show-digits-btn" onclick="toggleCardDigits(this)" title="Show/hide card digits">
                  <i class="fa-solid fa-eye"></i>
                </button>
              </div>
              <button class="customer-action-btn" onclick="updateCardPayment('John Mitch', 'john.mitch@gmail.com')">Update Card</button>
              <button class="customer-action-btn" onclick="openSendMandateModal('John Mitch', 'john.mitch@gmail.com')">Send Mandate</button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="page-section" id="shop-section">
        <div class="page-title">
          <h1>Store</h1>
        </div>
        <div class="store-container">
          <div class="store-products">
            <!-- Product 1: Yoga Class -->
            <div class="store-product-card">
              <div class="product-image-placeholder">
                <img alt="Yoga Class Icon" src="https://img.icons8.com/ios-filled/50/000000/lotus.png" />
              </div>
              <h3 class="product-title">Yoga Class</h3>
              <p class="product-stock">12 left in stock</p>
              <p class="product-price">£15.00</p>
              <button class="btn add-to-cart-btn" onclick="openPaymentModalWithProduct('Yoga Class', '15.00')">Collect Payment</button>
            </div>
            <!-- Product 2: Protein Shake -->
            <div class="store-product-card">
              <div class="product-image-placeholder">
                <img alt="Protein Shake Icon" src="https://img.icons8.com/ios-filled/50/000000/milkshake.png" />
              </div>
              <h3 class="product-title">Protein Shake</h3>
              <p class="product-stock">6 left in stock</p>
              <p class="product-price">£25.00</p>
              <button class="btn add-to-cart-btn" onclick="openPaymentModalWithProduct('Protein Shake', '25.00')">Collect Payment</button>
            </div>
            <!-- Product 3: Yoga Mat -->
            <div class="store-product-card">
              <div class="product-image-placeholder">
                <img alt="Yoga Mat Icon" src="https://img.icons8.com/ios-filled/50/000000/yoga.png" />
              </div>
              <h3 class="product-title">Yoga Mat</h3>
              <p class="product-stock">5 left in stock</p>
              <p class="product-price">£12.00</p>
              <button class="btn add-to-cart-btn" onclick="openPaymentModalWithProduct('Yoga Mat', '12.00')">Collect Payment</button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="page-section" id="activities-section">
        <div class="page-title">
          <h1>Activities & Services</h1>
          <button class="btn" style="margin-left: auto;">
            <i class="fa-solid fa-plus"></i> Add Activity
          </button>
        </div>
        <div class="store-container">
          <div class="store-products">
            <!-- Activity 1: Arts & Crafts -->
            <div class="store-product-card">
              <div class="product-image-placeholder">
                <img alt="Arts & Crafts" src="https://img.icons8.com/ios-filled/50/6AB04C/paint-palette.png" />
              </div>
              <h3 class="product-title">Arts & Crafts</h3>
              <p class="product-stock">Daily sessions available</p>
              <p class="product-price">£8.00/session</p>
              <button class="btn add-to-cart-btn" onclick="openPaymentModalWithProduct('Arts & Crafts', '8.00')">Book Session</button>
            </div>
            <!-- Activity 2: Music Time -->
            <div class="store-product-card">
              <div class="product-image-placeholder">
                <img alt="Music Time" src="https://img.icons8.com/ios-filled/50/6AB04C/musical-notes.png" />
              </div>
              <h3 class="product-title">Music Time</h3>
              <p class="product-stock">3 sessions weekly</p>
              <p class="product-price">£10.00/session</p>
              <button class="btn add-to-cart-btn" onclick="openPaymentModalWithProduct('Music Time', '10.00')">Book Session</button>
            </div>
            <!-- Activity 3: Outdoor Play -->
            <div class="store-product-card">
              <div class="product-image-placeholder">
                <img alt="Outdoor Play" src="https://img.icons8.com/ios-filled/50/6AB04C/playground.png" />
              </div>
              <h3 class="product-title">Outdoor Play</h3>
              <p class="product-stock">Weather permitting</p>
              <p class="product-price">£5.00/session</p>
              <button class="btn add-to-cart-btn" onclick="openPaymentModalWithProduct('Outdoor Play', '5.00')">Book Session</button>
            </div>
            <!-- Activity 4: Story Time -->
            <div class="store-product-card">
              <div class="product-image-placeholder">
                <img alt="Story Time" src="https://img.icons8.com/ios-filled/50/6AB04C/book.png" />
              </div>
              <h3 class="product-title">Story Time</h3>
              <p class="product-stock">Daily at 2:30 PM</p>
              <p class="product-price">£3.00/session</p>
              <button class="btn add-to-cart-btn" onclick="openPaymentModalWithProduct('Story Time', '3.00')">Book Session</button>
            </div>
            <!-- Activity 5: Sensory Play -->
            <div class="store-product-card">
              <div class="product-image-placeholder">
                <img alt="Sensory Play" src="https://img.icons8.com/ios-filled/50/6AB04C/hand.png" />
              </div>
              <h3 class="product-title">Sensory Play</h3>
              <p class="product-stock">Tue, Thu sessions</p>
              <p class="product-price">£12.00/session</p>
              <button class="btn add-to-cart-btn" onclick="openPaymentModalWithProduct('Sensory Play', '12.00')">Book Session</button>
            </div>
            <!-- Activity 6: Lunch Program -->
            <div class="store-product-card">
              <div class="product-image-placeholder">
                <img alt="Lunch Program" src="https://img.icons8.com/ios-filled/50/6AB04C/food.png" />
              </div>
              <h3 class="product-title">Lunch Program</h3>
              <p class="product-stock">Healthy meals daily</p>
              <p class="product-price">£6.50/meal</p>
              <button class="btn add-to-cart-btn" onclick="openPaymentModalWithProduct('Lunch Program', '6.50')">Order Meal</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Payment Portal Section -->
      <div class="page-section" id="payments-section">
        <div class="page-title">
          <h1>Payment Portal</h1>
        </div>
        <div class="table-container" style="padding:1rem;">
          <div id="pay_portal"></div>
        </div>
      </div>
      
      <div class="page-section" id="createPlan-section">
        <div class="page-title">
          <h1>Create Programs</h1>
        </div>
        <div style="background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
          <p style="color: var(--light-text-color); margin-bottom: 1rem;">Design age-appropriate learning programs and activities for your nursery children.</p>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
            <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem;">
              <h3 style="color: var(--primary-color); margin-bottom: 0.5rem;">Toddler Program (1-2 years)</h3>
              <p style="font-size: 0.9rem; color: var(--light-text-color);">Sensory play, music, movement, and basic social skills</p>
              <button class="btn" style="margin-top: 1rem; width: 100%;">Create Program</button>
            </div>
            <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem;">
              <h3 style="color: var(--primary-color); margin-bottom: 0.5rem;">Pre-School Program (3-4 years)</h3>
              <p style="font-size: 0.9rem; color: var(--light-text-color);">Early learning, literacy, numeracy, and creative expression</p>
              <button class="btn" style="margin-top: 1rem; width: 100%;">Create Program</button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="page-section" id="managePlan-section">
        <div class="page-title">
          <h1>Manage Programs</h1>
        </div>
        <div style="background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
          <div style="display: grid; gap: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid #e0e0e0; border-radius: 8px;">
              <div>
                <h4 style="color: var(--primary-color); margin-bottom: 0.25rem;">Morning Circle Time</h4>
                <p style="font-size: 0.9rem; color: var(--light-text-color);">Daily 9:00 AM - 9:30 AM • Ages 2-4</p>
              </div>
              <div style="display: flex; gap: 0.5rem;">
                <button class="btn" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">Edit</button>
                <button class="btn" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; background: var(--warning-color);">Delete</button>
              </div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid #e0e0e0; border-radius: 8px;">
              <div>
                <h4 style="color: var(--primary-color); margin-bottom: 0.25rem;">Creative Arts Workshop</h4>
                <p style="font-size: 0.9rem; color: var(--light-text-color);">Tuesday & Thursday 10:00 AM - 11:00 AM • Ages 3-5</p>
              </div>
              <div style="display: flex; gap: 0.5rem;">
                <button class="btn" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">Edit</button>
                <button class="btn" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; background: var(--warning-color);">Delete</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="page-section" id="salesInvoices-section">
        <div class="page-title">
          <h1>Invoices</h1>
        </div>
        <div class="table-container"
          style="background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1rem; overflow-x: auto;">
          <table style="width:100%; border-collapse: collapse; min-width: 750px;" class="responsive-table">
            <thead style="background: var(--table-header-bg); color: white;">
              <tr>
                <th scope="col" style="text-align:left; padding: 12px;">Invoice ID</th>
                <th scope="col" style="text-align:left; padding: 12px;">Parent</th>
                <th scope="col" style="text-align:left; padding: 12px;">Child</th>
                <th scope="col" style="text-align:left; padding: 12px;">Amount</th>
                <th scope="col" style="text-align:left; padding: 12px;">Date</th>
                <th scope="col" style="text-align:left; padding: 12px;">Due Date</th>
                <th scope="col" style="text-align:left; padding: 12px;">Payment Status</th>
                <th scope="col" style="text-align:left; padding: 12px; min-width: 150px;">Action</th>
              </tr>
            </thead>
            <tbody id="invoicesTableBody">
              <!-- Dynamic invoice rows will be inserted here -->
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Staff Section -->
      <div class="page-section" id="staff-section">
        <div class="page-title">
          <h1>Staff Management</h1>
          <button class="btn" style="margin-left: auto;">
            <i class="fa-solid fa-plus"></i> Add Staff
          </button>
        </div>
        
        <div class="cards">
          <div class="card">
            <h2>Total Staff</h2>
            <p class="value" style="color: var(--primary-color);">18</p>
            <p class="subtitle">Active employees</p>
          </div>
          <div class="card">
            <h2>On Duty Today</h2>
            <p class="value" style="color: var(--success-color);">12</p>
            <p class="subtitle">Current shift</p>
          </div>
          <div class="card">
            <h2>Qualified Staff</h2>
            <p class="value" style="color: var(--accent-color);">15</p>
            <p class="subtitle">Certified childcare</p>
          </div>
          <div class="card">
            <h2>Training Due</h2>
            <p class="value" style="color: var(--warning-color);">3</p>
            <p class="subtitle">Requires attention</p>
          </div>
        </div>
        
        <!-- Staff List -->
        <div class="customer-list">
          <!-- Staff 1 -->
          <div class="customer-card">
            <div class="customer-header">
              <div class="avatar" style="background-color: #E8F5E8;">JS</div>
              <div class="customer-info">
                <div class="customer-name">
                  Jenny Smith
                </div>
                <div class="customer-email">Lead Childcare Practitioner • jenny.smith@nurserycare.com</div>
              </div>
            </div>
            <div class="customer-details">
              <div class="customer-card-info">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <i class="fa-solid fa-clock" style="color: var(--success-color);"></i>
                  <span>8:00 AM - 4:00 PM • Level 3 Qualified</span>
                </div>
              </div>
              <button class="customer-action-btn" onclick="viewStaffProfile('Jenny Smith')">View Profile</button>
              <button class="customer-action-btn" onclick="editStaffSchedule('Jenny Smith')">Edit Schedule</button>
            </div>
          </div>
          <!-- Staff 2 -->
          <div class="customer-card">
            <div class="customer-header">
              <div class="avatar" style="background-color: #FFE5B4;">MT</div>
              <div class="customer-info">
                <div class="customer-name">
                  Mark Thompson
                </div>
                <div class="customer-email">Nursery Assistant • mark.thompson@nurserycare.com</div>
              </div>
            </div>
            <div class="customer-details">
              <div class="customer-card-info">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <i class="fa-solid fa-clock" style="color: var(--success-color);"></i>
                  <span>9:00 AM - 5:00 PM • Level 2 Qualified</span>
                </div>
              </div>
              <button class="customer-action-btn" onclick="viewStaffProfile('Mark Thompson')">View Profile</button>
              <button class="customer-action-btn" onclick="editStaffSchedule('Mark Thompson')">Edit Schedule</button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="page-section" id="settings-section">
        <div class="page-title">
          <h1>Settings</h1>
        </div>
        <div class="settings-container" style="margin-top: 1.5rem; background: var(--card-bg-color); border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem; max-width: 700px;">
          <h2 style="font-size: 1.2rem; margin-bottom: 1rem; color: var(--primary-color);">API Information</h2>
          
          <div class="api-info-section" style="margin-bottom: 1.5rem;">
            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-weight: 600; margin-bottom: 0.3rem; font-size: 0.9rem; color: var(--light-text-color);">Vendor ID:</label>
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <input id="vendorIdValue" type="text" readonly style="flex: 1; padding: 0.6rem; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f8f8; font-family: monospace;" value="Loading..." />
                <button onclick="copyToClipboard('vendorIdValue')" style="padding: 0.6rem; background: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">
                  <i class="fa-solid fa-copy"></i>
                </button>
              </div>
            </div>
            
            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-weight: 600; margin-bottom: 0.3rem; font-size: 0.9rem; color: var(--light-text-color);">Access Token:</label>
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <input id="accessTokenValue" type="text" readonly style="flex: 1; padding: 0.6rem; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f8f8; font-family: monospace;" value="Loading..." />
                <button onclick="copyToClipboard('accessTokenValue')" style="padding: 0.6rem; background: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">
                  <i class="fa-solid fa-copy"></i>
                </button>
              </div>
            </div>
          </div>
          
          <h2 style="font-size: 1.2rem; margin-bottom: 1rem; color: var(--primary-color);">Version Information</h2>
          <div style="display: flex; align-items: center;">
            <div style="background: var(--primary-color); color: white; padding: 0.5rem 1rem; border-radius: 4px; font-weight: 600; font-size: 1.2rem;">
              Version: <span id="versionNumber">1</span>
            </div>
          </div>
          <p style="margin-top: 0.5rem; color: #666; font-size: 0.9rem; font-style: italic;">
            This counter automatically increments with each change to the application.
          </p>
        </div>
      </div>
      
      <!-- Bookings Section -->
      <div class="page-section" id="bookings-section">
        <div class="page-title">
          <h1>Bookings</h1>
          <div style="display: flex; gap: 0.5rem;">
            <select style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
              <option>Today</option>
              <option>This Week</option>
              <option>This Month</option>
            </select>
            <button class="btn">
              <i class="fa-solid fa-plus"></i> New Booking
            </button>
          </div>
        </div>
        
        <div class="cards">
          <div class="card">
            <h2>Today's Sessions</h2>
            <p class="value" style="color: var(--success-color);">89</p>
            <p class="subtitle">Confirmed bookings</p>
          </div>
          <div class="card">
            <h2>Available Spaces</h2>
            <p class="value" style="color: var(--primary-color);">23</p>
            <p class="subtitle">Remaining capacity</p>
          </div>
          <div class="card">
            <h2>Waitlist</h2>
            <p class="value" style="color: var(--accent-color);">7</p>
            <p class="subtitle">Pending requests</p>
          </div>
          <div class="card">
            <h2>Cancellations</h2>
            <p class="value" style="color: var(--warning-color);">3</p>
            <p class="subtitle">Today's cancellations</p>
          </div>
        </div>
        
        <!-- Booking Calendar/Timeline would go here -->
        <div style="background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-top: 1rem;">
          <h3 style="margin-bottom: 1rem; color: var(--primary-color);">Today's Schedule</h3>
          <div style="display: grid; gap: 1rem;">
            <!-- Time slots -->
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f8f9fa; border-radius: 4px;">
              <div>
                <strong>8:00 AM - 12:00 PM</strong>
                <p style="color: var(--light-text-color); font-size: 0.9rem;">Morning Session</p>
              </div>
              <div style="display: flex; align-items: center; gap: 1rem;">
                <span style="color: var(--success-color); font-weight: 600;">42/50 children</span>
                <button class="btn" style="padding: 0.4rem 0.8rem; font-size: 0.9rem;">View Details</button>
              </div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f8f9fa; border-radius: 4px;">
              <div>
                <strong>12:00 PM - 6:00 PM</strong>
                <p style="color: var(--light-text-color); font-size: 0.9rem;">Afternoon Session</p>
              </div>
              <div style="display: flex; align-items: center; gap: 1rem;">
                <span style="color: var(--success-color); font-weight: 600;">47/50 children</span>
                <button class="btn" style="padding: 0.4rem 0.8rem; font-size: 0.9rem;">View Details</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Onboarding Modal -->
  <div class="modal-backdrop" id="onboardingModal" style="display: none;">
    <div class="modal-content" style="position: relative; width: 90%; max-width: 600px;">
      <button class="close-btn" onclick="closeOnboardingModal()">×</button>
      <div id="onboarding"></div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); z-index: 2000; justify-content: center; align-items: center; flex-direction: column;">
    <div style="width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite;"></div>
    <p style="margin-top: 15px; font-weight: 500;">Loading...</p>
  </div>

  <!-- Payment Option Modal -->
  <div class="modal-backdrop" id="paymentOptionModal" style="display: none;">
    <div class="modal-content" style="width: 500px; max-width: 95%; padding: 1.5rem;">
      <button class="close-btn" onclick="closeModal('paymentOptionModal')">×</button>
      
      <h2 style="margin-top: 0; margin-bottom: 1.5rem; text-align: center; font-size: 1.4rem;">Collect Payment</h2>
      
      <div style="margin-bottom: 1.5rem;">
        <div class="product-amount-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.2rem;">
          <div style="flex: 2; margin-right: 1rem;">
            <label for="modalProductSelect" style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 1rem;">Service/Activity</label>
            <select id="modalProductSelect" onchange="updateModalProductAmount()" style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem;">
              <option data-name="Arts & Crafts" value="8.00">Arts & Crafts Session</option>
              <option data-name="Music Time" value="10.00">Music Time Session</option>
              <option data-name="Outdoor Play" value="5.00">Outdoor Play Session</option>
              <option data-name="Story Time" value="3.00">Story Time Session</option>
              <option data-name="Sensory Play" value="12.00">Sensory Play Session</option>
              <option data-name="Lunch Program" value="6.50">Lunch Program</option>
              <option data-name="Full Day Care" value="45.00">Full Day Care</option>
              <option data-name="Half Day Care" value="25.00">Half Day Care</option>
            </select>
          </div>
          <div style="flex: 1;">
            <label for="modalAmountInput" style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 1rem;">Amount (£)</label>
            <input id="modalAmountInput" style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem;" type="text" value="8.00" />
          </div>
        </div>
        
        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Parent</label>
          <select id="customerSelect" onchange="updateSavedCardInfo()" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            <option value="sarah">Sarah Johnson (sarah.johnson@gmail.com)</option>
            <option value="michael">Michael Mitchell (mike.mitchell@gmail.com)</option>
            <option value="lisa">Lisa O'Connor (lisa.oconnor@gmail.com)</option>
          </select>
        </div>
      </div>
      
      <!-- Payment Method Tabs -->
      <div style="margin-bottom: 1.5rem;">
        <label style="display: block; margin-bottom: 1rem; font-weight: 500; font-size: 1.05rem;">Payment Options</label>
        
        <!-- Payment Method Selector (for mobile) -->
        <div class="payment-method-selector" style="display: none; margin-bottom: 1rem; position: relative;">
          <div class="selector-button" style="width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem; cursor: pointer; display: flex; align-items: center; justify-content: space-between; background-color: white;">
            <div class="selected-option">
              <i class="fa-solid fa-cash-register" style="margin-right: 8px;"></i>
              <span>Terminal</span>
            </div>
            <i class="fa-solid fa-chevron-up" style="transform: rotate(180deg); transition: transform 0.3s;"></i>
          </div>
        </div>
        
        <!-- Original dropdown (hidden) -->
        <select id="paymentMethodDropdown" style="display: none;">
          <option value="terminal">Terminal</option>
          <option value="saved-card">Saved Card</option>
          <option value="online">Online</option>
          <option value="direct-debit">Direct Debit</option>
        </select>
        
        <div class="payment-tabs" style="display: flex; border-bottom: 1px solid #ddd; gap: 10px;">
          <div class="payment-tab active" data-tab="terminal" onclick="switchPaymentTab(this, 'terminal')" 
               style="flex: 1; text-align: center; padding: 0.75rem 0; cursor: pointer; font-weight: 500; border-bottom: 2px solid var(--primary-color);">
            <i class="fa-solid fa-cash-register" style="display: block; font-size: 1.2rem; margin-bottom: 8px;"></i>
            Terminal
          </div>
          <div class="payment-tab" data-tab="saved-card" onclick="switchPaymentTab(this, 'saved-card')" 
               style="flex: 1; text-align: center; padding: 0.75rem 0; cursor: pointer; font-weight: 500;">
            <i class="fa-solid fa-credit-card" style="display: block; font-size: 1.2rem; margin-bottom: 8px;"></i>
            Saved Card
          </div>
          <div class="payment-tab" data-tab="online" onclick="switchPaymentTab(this, 'online')" 
               style="flex: 1; text-align: center; padding: 0.75rem 0; cursor: pointer; font-weight: 500;">
            <i class="fa-solid fa-globe" style="display: block; font-size: 1.2rem; margin-bottom: 8px;"></i>
            Online
          </div>
          <div class="payment-tab" data-tab="direct-debit" onclick="switchPaymentTab(this, 'direct-debit')" 
               style="flex: 1; text-align: center; padding: 0.75rem 0; cursor: pointer; font-weight: 500;">
            <i class="fa-solid fa-university" style="display: block; font-size: 1.2rem; margin-bottom: 8px;"></i>
            Direct Debit
          </div>
        </div>
        
        <!-- Tab Content -->
        <div class="tab-content" style="padding-top: 1.2rem;">
          <!-- Terminal Tab (active by default) -->
          <div id="terminal-tab" class="tab-pane active" style="display: block;">
            <p style="margin-bottom: 1rem; color: #666; font-size: 0.95rem;">Process payment using a card terminal device.</p>
          </div>
          
          <!-- Saved Card Tab -->
          <div id="saved-card-tab" class="tab-pane" style="display: none;">
            <p style="margin-bottom: 1rem; color: #666; font-size: 0.95rem;">Charge the parent's saved card on file.</p>
            <div id="saved-card-info" style="background: #f9f9f9; padding: 0.75rem; border-radius: 4px; display: flex; align-items: center; margin-bottom: 1rem;">
              <i class="fa-solid fa-credit-card" style="margin-right: 0.75rem; font-size: 1.2rem; color: #555;"></i>
              <div>
                <div id="card-type-number" style="font-weight: 500; font-size: 1rem;">Visa ending in 4321</div>
                <div id="card-expiry" style="font-size: 0.9rem; color: #777;">Expires 04/28</div>
              </div>
            </div>
          </div>
          
          <!-- Online Tab -->
          <div id="online-tab" class="tab-pane" style="display: none;">
            <p style="margin-bottom: 1rem; color: #666; font-size: 0.95rem;">Send an online payment link to the parent.</p>
            <div style="margin-bottom: 1rem;">
              <div style="margin-bottom: 0.5rem;">
                <label style="display: flex; align-items: center; margin-bottom: 0.5rem; font-size: 0.95rem;">
                  <input type="checkbox" id="checkoutOptionCards" checked style="margin-right: 0.5rem;"> 
                  <span>Cards</span>
                  <i class="fa-solid fa-credit-card" style="margin-left: 0.5rem; color: #555;"></i>
                </label>
              </div>
              <div style="margin-bottom: 0.5rem;">
                <label style="display: flex; align-items: center; font-size: 0.95rem;">
                  <input type="checkbox" id="checkoutOptionOpenBanking" checked style="margin-right: 0.5rem;"> 
                  <span>Instant Bank Transfer</span>
                  <i class="fa-solid fa-university" style="margin-left: 0.5rem; color: #555;"></i>
                </label>
              </div>
              <div>
                <label style="display: flex; align-items: center; font-size: 0.95rem;">
                  <input type="checkbox" id="checkoutOptionTFC" style="margin-right: 0.5rem;"> 
                  <span>TFC (Tax Free Childcare)</span>
                  <i class="fa-solid fa-baby" style="margin-left: 0.5rem; color: #555;"></i>
                </label>
              </div>
            </div>
          </div>
          
          <!-- Direct Debit Tab -->
          <div id="direct-debit-tab" class="tab-pane" style="display: none;">
            <p style="margin-bottom: 1rem; color: #666; font-size: 0.95rem;">Set up a direct debit mandate for the parent.</p>
            <div style="background: #f9f9f9; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem;">
              <p style="margin-bottom: 0.5rem; font-weight: 500; font-size: 0.95rem;">Direct Debit Information</p>
              <p style="font-size: 0.9rem; color: #555;">This will send a mandate request to the parent to authorize future payments.</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Action Button -->
      <button id="paymentActionButton" onclick="onPayWithTerminbalClick('terminalPaymentModal')" 
              style="width: 100%; padding: 0.75rem; background-color: var(--secondary-color); color: white; border: none; border-radius: 4px; font-size: 1.05rem; font-weight: bold; cursor: pointer;">
        Pay by Terminal
      </button>
    </div>
  </div>

  <!-- Terminal Payment Modal -->
  <div class="modal-backdrop" id="terminalPaymentModal" style="display: none;">
    <div class="modal-content" style="text-align: center; padding: 2rem; position: relative;">
      <button class="close-btn" onclick="closeModal('terminalPaymentModal')">×</button>
      <div id="terminalSpinner">
        <div style="margin-bottom: 1rem;">
          <div class="spinner"
            style="border: 6px solid #eee; border-top: 6px solid #9CAF3F; border-radius: 50%; width: 48px; height: 48px; animation: spin 1s linear infinite; margin: auto;">
          </div>
        </div>
        <p id="terminalStatus" style="font-size: 1.1rem; font-weight: 500; color: #9CAF3F;">Waiting for payment...</p>
      </div>

      <div id="terminalSuccess" style="display: none;">
        <div style="margin-bottom: 1rem;">
          <div class="success-icon">
            <div class="checkmark"></div>
          </div>
        </div>
        <p id="successMessage" style="font-size: 1.1rem; font-weight: 500; color: #9CAF3F;">Payment successful</p>
      </div>
    </div>
  </div>

  <!-- Update Payment Modal (Send Payment Link) -->
  <div class="modal-backdrop" id="updatePaymentModal" style="display: none;">
    <div class="modal-content qr-modal" style="text-align: center; padding: 2rem; position: relative; max-width: 90%; width: 400px;">
      <button class="close-btn" onclick="closeModal('updatePaymentModal')">×</button>
      <h2 style="margin-bottom: 1.5rem; font-size: 1.4rem; color: var(--primary-color);">Share Payment Link</h2>
      <div class="button-row" style="display: flex; gap: 10px; margin-bottom: 1.5rem;">
        <button class="action-btn disabled-btn" style="flex: 1; padding: 8px; background: var(--menu-bg-color); color: #999; border: none; border-radius: 4px; cursor: not-allowed;">Send via Email</button>
        <button class="action-btn disabled-btn" style="flex: 1; padding: 8px; background: var(--menu-bg-color); color: #999; border: none; border-radius: 4px; cursor: not-allowed;">Send via SMS</button>
      </div>
      <p class="qr-instructions" style="margin-bottom: 1rem; color: #666; font-size: 0.95rem;">Use this QR code to access the checkout</p>
      <img alt="QR Code" class="qr-code" id="updatePaymentQRCode" src="" style="width: 180px; height: 180px; margin: 0 auto 1.5rem; display: block; border: 1px solid #eee; padding: 5px; border-radius: 4px;" />
      <button class="copy-qr-btn" onclick="openPaymentLink()" style="margin: 0 auto 1.5rem; display: block; padding: 10px 20px; background-color: var(--secondary-color); color: white; border: none; border-radius: 4px; font-weight: 500; cursor: pointer;">Open in New Tab</button>
      <p class="payment-link-label" style="margin-bottom: 0.5rem; color: #666; font-size: 0.9rem;">Payment Link:</p>
      <a class="payment-link-value" href="#" id="updatePaymentLink" onclick="openFloatingModal(this.href); return false;" target="_blank" style="word-break: break-all; display: block; margin-bottom: 1rem; font-size: 0.9rem; color: var(--secondary-color);">https://pay.example.com/12345</a>
    </div>
  </div>
  
  <!-- Mandate Modal (Send Mandate Link) -->
  <div class="modal-backdrop" id="mandateModal" style="display: none;">
    <div class="modal-content qr-modal" style="text-align: center; padding: 2rem; position: relative; max-width: 90%; width: 400px;">
      <button class="close-btn" onclick="closeModal('mandateModal')">×</button>
      <h2 style="margin-bottom: 1.5rem; font-size: 1.4rem; color: var(--primary-color);">Share Mandate Link</h2>
      <div class="button-row" style="display: flex; gap: 10px; margin-bottom: 1.5rem;">
        <button class="action-btn disabled-btn" style="flex: 1; padding: 8px; background: var(--menu-bg-color); color: #999; border: none; border-radius: 4px; cursor: not-allowed;">Send via Email</button>
        <button class="action-btn disabled-btn" style="flex: 1; padding: 8px; background: var(--menu-bg-color); color: #999; border: none; border-radius: 4px; cursor: not-allowed;">Send via SMS</button>
      </div>
      <p class="qr-instructions" style="margin-bottom: 1rem; color: #666; font-size: 0.95rem;">Use this QR code to access the mandate</p>
      <img alt="Mandate QR Code" class="qr-code" id="mandateQRCode" src="" style="width: 180px; height: 180px; margin: 0 auto 1.5rem; display: block; border: 1px solid #eee; padding: 5px; border-radius: 4px;" />
      <button class="copy-qr-btn" onclick="copyMandateQRCode()" style="margin: 0 auto 1.5rem; display: block; padding: 10px 20px; background-color: var(--secondary-color); color: white; border: none; border-radius: 4px; font-weight: 500; cursor: pointer;">Open Link</button>
      <p class="payment-link-label" style="margin-bottom: 0.5rem; color: #666; font-size: 0.9rem;">Mandate Link:</p>
      <a class="payment-link-value" href="#" id="mandateLink" onclick="openFloatingModal(this.href); return false;" target="_blank" style="word-break: break-all; display: block; margin-bottom: 1rem; font-size: 0.9rem; color: var(--secondary-color);">https://mandate.example.com/12345</a>
    </div>
  </div>

  <!-- Floating Preview Modal -->
  <div class="floating-modal" id="floatingPreviewModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 2200; background-color: rgba(0,0,0,0.7); padding: 20px; overflow: hidden;">
    <div class="floating-modal-content" style="position: relative; width: 450px; height: 700px; max-width: calc(100vw - 40px); max-height: calc(100vh - 40px); margin: 0 auto; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.3);">
      <button class="floating-close-btn" onclick="closeFloatingModal()" style="position: absolute; top: 10px; right: 10px; z-index: 2300; width: 34px; height: 34px; border-radius: 50%; background: rgba(0,0,0,0.6); color: white; border: none; font-size: 18px; display: flex; align-items: center; justify-content: center; cursor: pointer;">×</button>
      <iframe id="previewIframe" src="" scrolling="auto" frameborder="0" style="overflow-x: hidden !important; width: 100% !important; max-width: 100% !important; height: 100%; border: none;"></iframe>
    </div>
  </div>
  
  <!-- Success Popup Modal -->
  <div class="modal-backdrop" id="successModal" style="display: none;">
    <div class="modal-content" style="text-align: center; padding: 2.5rem 2rem; position: relative; max-width: 90%; width: 400px; background-color: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
      <div style="margin: 0 auto 1.5rem; width: 80px; height: 80px; background-color: #4CAF50; border-radius: 50%; display: flex; align-items: center; justify-content: center; animation: scaleIn 0.5s ease-out;">
        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M9 16.2L4.8 12L3.4 13.4L9 19L21 7L19.6 5.6L9 16.2Z" fill="white"/>
        </svg>
      </div>
      <h2 style="margin: 0 0 10px; color: #333; font-size: 24px; font-weight: 600;">Payment Successful!</h2>
      <p id="successAmount" style="margin: 0 0 20px; font-size: 18px; color: #666;">Your payment of <span style="font-weight: 600; color: #9CAF3F;">£0.00</span> has been processed.</p>
      <button onclick="closeSuccessModal()" style="background-color: #9CAF3F; color: white; border: none; padding: 12px 24px; font-size: 16px; font-weight: 500; border-radius: 6px; cursor: pointer; transition: background-color 0.2s ease;">
        Continue
      </button>
    </div>
  </div>

  <!-- Payment Options Bottom Sheet -->
  <div class="bottom-sheet-backdrop" id="paymentOptionsBackdrop"></div>
  <div class="bottom-sheet" id="paymentOptionsSheet">
    <div class="bottom-sheet-indicator"></div>
    <div class="bottom-sheet-header">
      <h3 class="bottom-sheet-title">Payment Options</h3>
      <button class="close-btn" style="position: relative; top: 0; right: 0;" onclick="closeBottomSheet()">×</button>
    </div>
    <div class="bottom-sheet-content">
      <div class="bottom-sheet-option selected" data-value="terminal" onclick="selectPaymentOption(this, 'terminal')">
        <i class="fa-solid fa-cash-register"></i>
        <span class="bottom-sheet-option-text">Terminal</span>
      </div>
      <div class="bottom-sheet-option" data-value="saved-card" onclick="selectPaymentOption(this, 'saved-card')">
        <i class="fa-solid fa-credit-card"></i>
        <span class="bottom-sheet-option-text">Saved Card</span>
      </div>
      <div class="bottom-sheet-option" data-value="online" onclick="selectPaymentOption(this, 'online')">
        <i class="fa-solid fa-globe"></i>
        <span class="bottom-sheet-option-text">Online</span>
      </div>
      <div class="bottom-sheet-option" data-value="direct-debit" onclick="selectPaymentOption(this, 'direct-debit')">
        <i class="fa-solid fa-university"></i>
        <span class="bottom-sheet-option-text">Direct Debit</span>
      </div>
    </div>
  </div>

  <!-- TFC Checkout Modal -->
  <div class="modal-backdrop" id="tfcCheckoutModal" style="display: none;">
    <div class="modal-content" style="width: 600px; max-width: 95%; padding: 2rem; position: relative;">
      <button class="close-btn" onclick="closeModal('tfcCheckoutModal')">×</button>
      <h2 style="margin-top: 0; margin-bottom: 1.5rem; text-align: center; font-size: 1.4rem; color: var(--primary-color);">TFC Payment</h2>
      
      <div class="checkout-container" style="background: #ffffff; border: 1px solid #eceff3; border-radius: 6px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); padding: 30px; width: 100%; box-sizing: border-box;">
        <!-- Container for the TFC checkout embed -->
        <div id="tfcCheckout"></div>
      </div>
    </div>
  </div>

  <!-- Children Section -->
  <div class="page-section" id="children-section">
  </div>

  <script>
    // Global variables
    let savedToken = "E5Gd8x4QdM/eU2AyNF+gPg==";
    let globalVendorId = null;
    let balanceComponents = null;
    let balanceInstance = null;
    let isLoadingBalance = false;
    let forceBalanceReload = false;
    let isTogglingVendor = false;
    let payPortalLoaded = false;
    let payPortalInstance = null;
    let invoices = []; // Array to store invoices
    let currentInvoiceId = null; // Track current invoice
    let currentVersion = 5; // Version counter (incremented for each change)
    let latestAccessToken = null; // Store the latest access token
    
    // UniPaas configuration - Updated to match nursery software colors
    const unipaasDefaultConfig = {
      paymentsEnabled: true,
      theme: {
        colors: {
          primaryColor: "#9CAF3F",           // Main olive-green from table headers
          secondaryColor: "#B8C65A",         // Lighter olive for secondary elements
          accentTextColor: "#9CAF3F",        // Olive-green for accent text
          primaryButtonColor: "#9CAF3F",     // Primary buttons in olive-green
          backgroundColor: "#F5F4E8",        // Light cream background
          textColor: "#2C3E50",              // Dark text color
          borderColor: "#D1D5DB",            // Light border color
          hoverColor: "#7A8F32",             // Darker olive for hover states
          tableHeaderColor: "#9CAF3F",       // Table header background
          tableRowColor: "#E8E6D3",          // Alternating table row color
          successColor: "#10B981",           // Success green
          warningColor: "#EF4444",           // Warning red
          infoColor: "#3B82F6"               // Info blue
        },
        fontFamily: "Inter, sans-serif",
        boxShadow: "0px 3px 15px rgba(156, 175, 63, 0.15)",  // Olive-tinted shadow
        borderRadius: "8px",
        spacing: {
          padding: "12px",
          margin: "8px"
        }
      }
    };

    // Function to apply nursery software styling to UniPaas components
    function applyNurseryThemeToUniPaas() {
      // This function will be called whenever new UniPaas content is loaded
      const unipaasElements = document.querySelectorAll('[data-unipaas]');
      unipaasElements.forEach(element => {
        // Ensure our CSS classes are applied
        element.classList.add('nursery-themed');
        
        // Apply specific styling to tables that might be dynamically loaded
        const tables = element.querySelectorAll('table');
        tables.forEach(table => {
          table.classList.add('responsive-table');
          
          // Force table header styling
          const headers = table.querySelectorAll('th');
          headers.forEach(th => {
            th.style.setProperty('background-color', '#9CAF3F', 'important');
            th.style.setProperty('background', '#9CAF3F', 'important');
            th.style.setProperty('color', 'white', 'important');
            th.style.setProperty('font-weight', '600', 'important');
            th.style.setProperty('padding', '12px', 'important');
          });
          
          // Force alternating row colors
          const rows = table.querySelectorAll('tbody tr');
          rows.forEach((row, index) => {
            const cells = row.querySelectorAll('td');
            if (index % 2 === 0) {
              // Odd rows (0-indexed) should be white
              row.style.setProperty('background-color', 'white', 'important');
              row.style.setProperty('background', 'white', 'important');
              cells.forEach(cell => {
                cell.style.setProperty('background-color', 'white', 'important');
                cell.style.setProperty('background', 'white', 'important');
              });
            } else {
              // Even rows (0-indexed) should be olive/beige
              row.style.setProperty('background-color', '#E8E6D3', 'important');
              row.style.setProperty('background', '#E8E6D3', 'important');
              cells.forEach(cell => {
                cell.style.setProperty('background-color', '#E8E6D3', 'important');
                cell.style.setProperty('background', '#E8E6D3', 'important');
              });
            }
            
            // Add hover effect
            row.addEventListener('mouseenter', function() {
              this.style.setProperty('background-color', '#DDD9C4', 'important');
              this.style.setProperty('background', '#DDD9C4', 'important');
              const hoverCells = this.querySelectorAll('td');
              hoverCells.forEach(cell => {
                cell.style.setProperty('background-color', '#DDD9C4', 'important');
                cell.style.setProperty('background', '#DDD9C4', 'important');
              });
            });
            
            row.addEventListener('mouseleave', function() {
              const rowIndex = Array.from(this.parentElement.children).indexOf(this);
              const bgColor = rowIndex % 2 === 0 ? 'white' : '#E8E6D3';
              this.style.setProperty('background-color', bgColor, 'important');
              this.style.setProperty('background', bgColor, 'important');
              const leaveCells = this.querySelectorAll('td');
              leaveCells.forEach(cell => {
                cell.style.setProperty('background-color', bgColor, 'important');
                cell.style.setProperty('background', bgColor, 'important');
              });
            });
          });
        });
        
        // Force button styling for UniPaas components
        const buttons = element.querySelectorAll('button, [role="button"], .btn, input[type="submit"], input[type="button"]');
        buttons.forEach(button => {
          button.style.setProperty('background-color', '#9CAF3F', 'important');
          button.style.setProperty('border-color', '#9CAF3F', 'important');
          button.style.setProperty('color', 'white', 'important');
          
          // Add hover event listeners
          button.addEventListener('mouseenter', function() {
            this.style.setProperty('background-color', '#7A8F32', 'important');
            this.style.setProperty('border-color', '#7A8F32', 'important');
          });
          
          button.addEventListener('mouseleave', function() {
            this.style.setProperty('background-color', '#9CAF3F', 'important');
            this.style.setProperty('border-color', '#9CAF3F', 'important');
          });
        });
      });
    }

    // Set up a global mutation observer to catch dynamically loaded UniPaas content
    const globalObserver = new MutationObserver((mutations) => {
      let shouldApplyTheme = false;
      mutations.forEach(mutation => {
        if (mutation.type === 'childList') {
          mutation.addedNodes.forEach(node => {
            if (node.nodeType === 1) { // Element node
              if (node.hasAttribute && node.hasAttribute('data-unipaas')) {
                shouldApplyTheme = true;
              }
              // Check for nested UniPaas elements
              if (node.querySelectorAll && node.querySelectorAll('[data-unipaas]').length > 0) {
                shouldApplyTheme = true;
              }
            }
          });
        }
      });
      
      if (shouldApplyTheme) {
        setTimeout(applyNurseryThemeToUniPaas, 100); // Small delay to ensure content is rendered
        setTimeout(injectStrongTableStyles, 200); // Additional delay for stronger overrides
      }
    });

    // Function to inject very specific CSS overrides for UniPaas tables
    function injectStrongTableStyles() {
      // Remove any existing override styles
      const existingStyle = document.getElementById('unipaas-table-override');
      if (existingStyle) {
        existingStyle.remove();
      }
      
      // Create a new style element with very specific selectors
      const style = document.createElement('style');
      style.id = 'unipaas-table-override';
      style.innerHTML = `
        /* Ultra-specific selectors for UniPaas table styling */
        div[data-unipaas] table tbody tr:nth-child(2n) td,
        div[data-unipaas] table tbody tr:nth-child(even) td,
        [data-unipaas] table tbody tr:nth-child(2n) td,
        [data-unipaas] table tbody tr:nth-child(even) td {
          background-color: #E8E6D3 !important;
          background: #E8E6D3 !important;
        }
        
        div[data-unipaas] table tbody tr:nth-child(2n+1) td,
        div[data-unipaas] table tbody tr:nth-child(odd) td,
        [data-unipaas] table tbody tr:nth-child(2n+1) td,
        [data-unipaas] table tbody tr:nth-child(odd) td {
          background-color: white !important;
          background: white !important;
        }
        
        div[data-unipaas] table tbody tr:nth-child(2n),
        div[data-unipaas] table tbody tr:nth-child(even),
        [data-unipaas] table tbody tr:nth-child(2n),
        [data-unipaas] table tbody tr:nth-child(even) {
          background-color: #E8E6D3 !important;
          background: #E8E6D3 !important;
        }
        
        div[data-unipaas] table tbody tr:nth-child(2n+1),
        div[data-unipaas] table tbody tr:nth-child(odd),
        [data-unipaas] table tbody tr:nth-child(2n+1),
        [data-unipaas] table tbody tr:nth-child(odd) {
          background-color: white !important;
          background: white !important;
        }
        
        /* Table headers */
        div[data-unipaas] table thead th,
        [data-unipaas] table thead th,
        div[data-unipaas] table th,
        [data-unipaas] table th {
          background-color: #9CAF3F !important;
          background: #9CAF3F !important;
          color: white !important;
          font-weight: 600 !important;
        }
        
        /* Ultra-aggressive button styling for UniPaas */
        div[data-unipaas] button,
        [data-unipaas] button,
        div[data-unipaas] .unipaas-button-events button,
        [data-unipaas] .unipaas-button-events button,
        div[data-unipaas] input[type="submit"],
        [data-unipaas] input[type="submit"],
        div[data-unipaas] input[type="button"],
        [data-unipaas] input[type="button"],
        div[data-unipaas] [role="button"],
        [data-unipaas] [role="button"] {
          background-color: #9CAF3F !important;
          background: #9CAF3F !important;
          border-color: #9CAF3F !important;
          border: 1px solid #9CAF3F !important;
          color: white !important;
        }
        
        div[data-unipaas] button:hover,
        [data-unipaas] button:hover,
        div[data-unipaas] .unipaas-button-events button:hover,
        [data-unipaas] .unipaas-button-events button:hover {
          background-color: #7A8F32 !important;
          background: #7A8F32 !important;
          border-color: #7A8F32 !important;
          border: 1px solid #7A8F32 !important;
        }
      `;
      
      // Append to head with highest priority
      document.head.appendChild(style);
    }

    // Start observing the document for changes
    globalObserver.observe(document.body, {
      childList: true,
      subtree: true
    });

    // Function to continuously apply button styling (for aggressive override)
    function forceButtonStyling() {
      const unipaasButtons = document.querySelectorAll('div[data-unipaas] button, [data-unipaas] button, .unipaas-button-events button, div[data-unipaas] .unipaas-button-events button');
      unipaasButtons.forEach(button => {
        button.style.setProperty('background-color', '#9CAF3F', 'important');
        button.style.setProperty('background', '#9CAF3F', 'important');
        button.style.setProperty('border-color', '#9CAF3F', 'important');
        button.style.setProperty('border', '1px solid #9CAF3F', 'important');
        button.style.setProperty('color', 'white', 'important');
        button.style.setProperty('box-shadow', '0px 4px 19.1px 0px rgba(156, 175, 63, 0.08)', 'important');
      });
    }

    // Initialize app when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Apply initial styling
      setTimeout(() => {
        applyNurseryThemeToUniPaas();
        injectStrongTableStyles();
        forceButtonStyling();
      }, 500);
      
      // Continuously apply button styling every 2 seconds to override UniPaas
      setInterval(forceButtonStyling, 2000);
      
      // Check for TFC parameter in URL first
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('tfc') === 'true') {
        console.log('TFC parameter detected, opening TFC Payment modal');
        // Small delay to ensure page is fully loaded
        setTimeout(() => {
          openTFCCheckoutModal(true);
          // Clean up URL by removing the tfc parameter
          urlParams.delete('tfc');
          const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
          window.history.replaceState({}, '', newUrl);
        }, 500);
      }
      
      // Show dashboard by default
      showTab('dashboard');
      
      // Create sample invoices
      createSampleInvoices();
      
      // Mobile menu toggle
      const mobileMenuBtn = document.getElementById('mobile-menu-toggle');
      if (mobileMenuBtn) {
        mobileMenuBtn.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('Mobile menu clicked'); // Debug log
          
          const sidebar = document.getElementById('sidebar');
          const backdrop = document.getElementById('sidebar-backdrop');
          
          if (sidebar && backdrop) {
            const isOpen = sidebar.classList.contains('mobile-visible');
            
            if (isOpen) {
              // Close sidebar
              sidebar.classList.remove('mobile-visible', 'active');
              backdrop.classList.remove('active');
              console.log('Sidebar closed'); // Debug log
            } else {
              // Open sidebar
              sidebar.classList.add('mobile-visible', 'active');
              backdrop.classList.add('active');
              console.log('Sidebar opened'); // Debug log
            }
          }
        });
      }
      
      // Close sidebar when clicking backdrop
      const sidebarBackdrop = document.getElementById('sidebar-backdrop');
      if (sidebarBackdrop) {
        sidebarBackdrop.addEventListener('click', function() {
          console.log('Backdrop clicked'); // Debug log
          const sidebar = document.getElementById('sidebar');
          const backdrop = document.getElementById('sidebar-backdrop');
          
          if (sidebar && backdrop) {
            sidebar.classList.remove('mobile-visible', 'active');
            backdrop.classList.remove('active');
            console.log('Sidebar closed via backdrop'); // Debug log
          }
        });
      }
      
      // Highlight active tab in sidebar
      document.querySelectorAll('#sidebar li').forEach(li => {
        li.addEventListener('click', () => {
          document.querySelectorAll('#sidebar li').forEach(el => el.classList.remove('active'));
          li.classList.add('active');
          
          // On mobile, hide sidebar after selection
          if (window.innerWidth < 767) {
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('sidebar-backdrop');
            sidebar.classList.remove('mobile-visible');
            backdrop.classList.remove('active');
          }
        });
      });

      // Add event listener for "Get Started" and "Start Now" buttons in both components
      document.addEventListener('click', function(e) {
        // Check if the clicked element is a button
        if (e.target.tagName === 'BUTTON') {
          const buttonText = e.target.textContent.trim().toUpperCase();
          console.log("Button clicked:", buttonText);
          
          // Match both "GET STARTED" and "START NOW" buttons
          if (buttonText === 'GET STARTED' || buttonText === 'START NOW') {
            console.log(buttonText + " button clicked - opening onboarding");
            e.preventDefault();
            e.stopPropagation();
            openOnboardingComponent();
          }
          
          // Match "COMPLETE ONBOARDING", "COMPLETE", "FINISH", and "FINISH ONBOARDING" buttons
          if (buttonText === 'COMPLETE ONBOARDING' || buttonText === 'COMPLETE' || 
              buttonText === 'FINISH' || buttonText === 'FINISH ONBOARDING') {
            console.log(buttonText + " button clicked - completing onboarding");
            e.preventDefault();
            e.stopPropagation();
            completeOnboarding();
          }
        }
      }, true); // Use capture phase to ensure we catch the event first

      // Add window resize event listener for responsive components
      window.addEventListener('resize', debounce(function() {
        // Update balance container
        const balanceContainer = document.getElementById("balance-dashboard");
        if (balanceContainer) {
          adjustContainerSize(balanceContainer);
        }
        
        // Update payment option UI based on screen size
        if (window.innerWidth <= 767) {
          // On mobile, show the selector and hide tabs
          const methodSelector = document.querySelector('.payment-method-selector');
          const paymentTabs = document.querySelector('.payment-tabs');
          
          if (methodSelector) methodSelector.style.display = 'block';
          if (paymentTabs) paymentTabs.style.display = 'none';
        } else {
          // On desktop, show tabs and hide selector
          const methodSelector = document.querySelector('.payment-method-selector');
          const paymentTabs = document.querySelector('.payment-tabs');
          
          if (methodSelector) methodSelector.style.display = 'none';
          if (paymentTabs) paymentTabs.style.display = 'flex';
          
          // If bottom sheet is open, close it
          closeBottomSheet();
        }
        
        // Any other responsive adjustments can go here
      }, 250)); // Debounce to prevent too many calls during resize

      // Wait for unipaas script to load
      waitForUnipaas();
      // Always initialize custom dropdown for mobile
      initCustomDropdown();
    });

    // Function to open the onboarding component
    function openOnboardingComponent() {
      console.log("Opening onboarding component...");
      
      // Increment version number when opening onboarding
      incrementVersion();
      
      // Show loading spinner
      const loadingOverlay = document.getElementById("loadingOverlay");
      if (!loadingOverlay) {
        console.error("Loading overlay element not found!");
        return;
      }
      loadingOverlay.style.display = "flex";

      // Don't show the onboarding modal until content is ready
      const modal = document.getElementById("onboardingModal");
      if (!modal) {
        console.error("Onboarding modal element not found!");
        loadingOverlay.style.display = "none";
        return;
      }
      
      // Check if we have a vendor ID, if not, we'll need to create one
      if (!globalVendorId) {
        fetch("https://sandbox.unipaas.com/platform/vendors", {
          method: "POST",
          headers: getApiHeaders(),
          body: JSON.stringify({
            "businessName": "Better Delivery",
            "type": "individual",
            "firstName": "John",
            "lastName": "Doe",
            "email": "john.doe@example.com",
            "country": "GB",
            "url": "http://example.com",
            "serviceDescription": "Gym operator",
            "birthDate": "1980-01-01",
            "phone": "+44912345678",
            "category": "FOOD_DELIVERY",
            "createOnboardingLink": true
          })
        })
        .then(response => response.json())
        .then(data => {
          console.log("Created new vendor:", data);
          globalVendorId = data.id;
          
          // Now that we have a vendor ID, proceed with onboarding
          continueWithOnboarding();
        })
        .catch(err => {
          console.error("Error creating vendor:", err);
          loadingOverlay.style.display = "none";
          alert("Failed to create vendor: " + err.message);
        });
      } else {
        // We already have a vendor ID, proceed directly
        continueWithOnboarding();
      }
      
      function continueWithOnboarding() {
        // Authorize for this vendor
        fetch("https://sandbox.unipaas.com/platform/authorize", {
          method: "POST",
          headers: getApiHeaders(),
          body: JSON.stringify({
            scopes: ["portal_read", "portal_write"],
            vendorId: globalVendorId
          })
        })
        .then(res => {
          if (!res.ok) {
            throw new Error(`Authorization failed with status: ${res.status}`);
          }
          return res.json();
        })
        .then(data => {
          console.log("Authorization successful, creating onboarding component");
          const newAccessToken = data.accessToken;
          
          // Store the latest access token for display in settings
          latestAccessToken = newAccessToken;
          
          // Create components with proper configuration
          if (!balanceComponents) {
            balanceComponents = unipaas.components(newAccessToken, unipaasDefaultConfig);
          } else {
            balanceComponents.reset({ accessToken: newAccessToken });
          }
          
          // Clean any existing content in the onboarding container
          const onboardingContainer = document.getElementById("onboarding");
          if (!onboardingContainer) {
            console.error("Onboarding container element not found!");
            loadingOverlay.style.display = "none";
            return;
          }
          
          console.log("Mounting onboarding component");
          
          // Create the onboarding component
          const onboarding = balanceComponents.create("onboarding");
          
          // Pre-set the address by initializing fields
          fetch(`https://sandbox.unipaas.com/platform/vendors/${globalVendorId}/onboarding`, {
            method: "POST",
            headers: getApiHeaders(),
            body: JSON.stringify({
              "fields": [
                {
                  "alias": "individual.address",
                  "value": {
                    "country": "GB",
                    "city": "London",
                    "street": "New Cavendish Street",
                    "houseNumber": "64",
                    "postCode": "W1G 8TB"
                  }
                },
                {
                  "alias": "business.bankAccount",
                  "value": "38290008"
                },
                {
                  "alias": "business.sortCode",
                  "value": "200415"
                }
              ]
            })
          })
          .then(() => {
            // Mount the onboarding component after setting up the fields
            onboarding.mount("#onboarding");
            
            // Show the modal and hide the loading overlay after address is set
            setTimeout(() => {
              console.log("Displaying onboarding modal with pre-set address");
              modal.style.display = "flex";
              loadingOverlay.style.display = "none";
            }, 500); // Delay to ensure component is fully rendered
          })
          .catch(err => {
            console.error("Error setting onboarding fields:", err);
            // Mount anyway even if field setup fails
            onboarding.mount("#onboarding");
            
            // Still show the modal even if address setup failed
            setTimeout(() => {
              console.log("Displaying onboarding modal (without pre-set address)");
              modal.style.display = "flex";
              loadingOverlay.style.display = "none";
            }, 500);
          });
        })
        .catch(err => {
          console.error("Error during onboarding setup:", err);
          alert("Error setting up onboarding: " + err.message);
          // Hide loading spinner on error
          loadingOverlay.style.display = "none";
        });
      }
    }

    // Function to complete the onboarding process (duplicate of openOnboardingComponent)
    function completeOnboarding() {
      console.log("Completing onboarding component...");
      
      // Increment version number when completing onboarding
      incrementVersion();
      
      // Show loading spinner
      const loadingOverlay = document.getElementById("loadingOverlay");
      if (!loadingOverlay) {
        console.error("Loading overlay element not found!");
        return;
      }
      loadingOverlay.style.display = "flex";

      // Don't show the onboarding modal until content is ready
      const modal = document.getElementById("onboardingModal");
      if (!modal) {
        console.error("Onboarding modal element not found!");
        loadingOverlay.style.display = "none";
        return;
      }
      
      // Check if we have a vendor ID, if not, we'll need to create one
      if (!globalVendorId) {
        fetch("https://sandbox.unipaas.com/platform/vendors", {
          method: "POST",
          headers: getApiHeaders(),
          body: JSON.stringify({
            "businessName": "Better Delivery",
            "type": "individual",
            "firstName": "John",
            "lastName": "Doe",
            "email": "john.doe@example.com",
            "country": "GB",
            "url": "http://example.com",
            "serviceDescription": "Gym operator",
            "birthDate": "1980-01-01",
            "phone": "+44912345678",
            "category": "FOOD_DELIVERY",
            "createOnboardingLink": true
          })
        })
        .then(response => response.json())
        .then(data => {
          console.log("Created new vendor:", data);
          globalVendorId = data.id;
          
          // Now that we have a vendor ID, proceed with onboarding
          continueWithCompleteOnboarding();
        })
        .catch(err => {
          console.error("Error creating vendor:", err);
          loadingOverlay.style.display = "none";
          alert("Failed to create vendor: " + err.message);
        });
      } else {
        // We already have a vendor ID, proceed directly
        continueWithCompleteOnboarding();
      }
      
      function continueWithCompleteOnboarding() {
        // Authorize for this vendor
        fetch("https://sandbox.unipaas.com/platform/authorize", {
          method: "POST",
          headers: getApiHeaders(),
          body: JSON.stringify({
            scopes: ["portal_read", "portal_write"],
            vendorId: globalVendorId
          })
        })
        .then(res => {
          if (!res.ok) {
            throw new Error(`Authorization failed with status: ${res.status}`);
          }
          return res.json();
        })
        .then(data => {
          console.log("Authorization successful, creating complete onboarding component");
          const newAccessToken = data.accessToken;
          
          // Store the latest access token for display in settings
          latestAccessToken = newAccessToken;
          
          // Create components with proper configuration
          if (!balanceComponents) {
            balanceComponents = unipaas.components(newAccessToken, unipaasDefaultConfig);
          } else {
            balanceComponents.reset({ accessToken: newAccessToken });
          }
          
          // Clean any existing content in the onboarding container
          const onboardingContainer = document.getElementById("onboarding");
          if (!onboardingContainer) {
            console.error("Onboarding container element not found!");
            loadingOverlay.style.display = "none";
            return;
          }
          
          console.log("Mounting complete onboarding component");
          
          // Create the onboarding component
          const onboarding = balanceComponents.create("onboarding");
          
          // Pre-set the address by initializing fields
          fetch(`https://sandbox.unipaas.com/platform/vendors/${globalVendorId}/onboarding`, {
            method: "POST",
            headers: getApiHeaders(),
            body: JSON.stringify({
              "fields": [
                {
                  "alias": "individual.address",
                  "value": {
                    "country": "GB",
                    "city": "London",
                    "street": "New Cavendish Street",
                    "houseNumber": "64",
                    "postCode": "W1G 8TB"
                  }
                },
                {
                  "alias": "business.bankAccount",
                  "value": "38290008"
                },
                {
                  "alias": "business.sortCode",
                  "value": "200415"
                }
              ]
            })
          })
          .then(() => {
            // Mount the onboarding component after setting up the fields
            onboarding.mount("#onboarding");
            
            // Show the modal and hide the loading overlay after address is set
            setTimeout(() => {
              console.log("Displaying complete onboarding modal with pre-set address");
              modal.style.display = "flex";
              loadingOverlay.style.display = "none";
            }, 500); // Delay to ensure component is fully rendered
          })
          .catch(err => {
            console.error("Error setting onboarding fields:", err);
            // Mount anyway even if field setup fails
            onboarding.mount("#onboarding");
            
            // Still show the modal even if address setup failed
            setTimeout(() => {
              console.log("Displaying complete onboarding modal (without pre-set address)");
              modal.style.display = "flex";
              loadingOverlay.style.display = "none";
            }, 500);
          });
        })
        .catch(err => {
          console.error("Error during complete onboarding setup:", err);
          alert("Error setting up complete onboarding: " + err.message);
          // Hide loading spinner on error
          loadingOverlay.style.display = "none";
        });
      }
    }

    // Function to close the onboarding modal
    function closeOnboardingModal() {
      console.log("Closing onboarding modal");
      const modal = document.getElementById("onboardingModal");
      if (modal) {
        modal.style.display = "none";
        
        // Clean up the onboarding container
        const onboardingContainer = document.getElementById("onboarding");
        if (onboardingContainer) {
          // Optional: Clear the container to free up resources
          // onboardingContainer.innerHTML = '';
        }
      } else {
        console.error("Onboarding modal element not found when trying to close!");
      }
    }

    // Function to get API headers with authorization token
    function getApiHeaders() {
      return {
        "Accept": "application/json",
        "Content-Type": "application/json",
        "Authorization": "Bearer " + savedToken
      };
    }

    // Debounce function to limit how often a function can be called
    function debounce(func, wait) {
      let timeout;
      return function() {
        const context = this;
        const args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          func.apply(context, args);
        }, wait);
      };
    }

    // Function to wait for unipaas to be available
    function waitForUnipaas() {
      // Check if unipaas is already available
      if (typeof unipaas !== 'undefined') {
        initializeUnipaas();
        return;
      }
      
      // Set an interval to check for unipaas
      const checkInterval = setInterval(() => {
        if (typeof unipaas !== 'undefined') {
          clearInterval(checkInterval);
          initializeUnipaas();
        }
      }, 500);

      // Safety timeout after 5 seconds
      setTimeout(() => {
        if (typeof unipaas === 'undefined') {
          clearInterval(checkInterval);
          
          // Try loading the script manually
          const script = document.createElement('script');
          script.src = 'https://cdn.unipaas.com/embedded-ui.js';
          script.onload = initializeUnipaas;
          document.head.appendChild(script);
        }
      }, 5000);
    }

    // Initialize unipaas components
    function initializeUnipaas() {
      // Only load balance component, don't auto-trigger onboarding
      loadBalance(false);
    }

    // Toggle HIM Vendor Functionality
    function toggleHIMVendor(checkbox) {
      // Prevent multiple rapid toggles
      if (isTogglingVendor) return;
      
      // If already checked (turning off), prevent the action
      if (!checkbox.checked) {
        alert("Cannot turn off onboarding. Please refresh the app if needed.");
        checkbox.checked = true;
        return;
      }
      
      isTogglingVendor = true;
      
      if (checkbox.checked) {
        globalVendorId = "6847c40e23cb8d730cca6dbc";
      } else {
        globalVendorId = null;
      }
      
      // Increment version due to this change
      incrementVersion();
      
      // Show loading spinner in balance container
      const balanceContainer = document.getElementById("balance-dashboard");
      if (balanceContainer) {
        balanceContainer.classList.add('loading');
        balanceContainer.classList.remove('content-loaded');
        const spinner = balanceContainer.querySelector('.balance-loading-spinner');
        if (spinner) {
          spinner.classList.add('visible');
        }
      }
      
      forceBalanceReload = true;
      payPortalLoaded = false; // Reset flag since we need to reload with new vendor
      
      // Update both the balance and pay portal components
      loadBalance();
      loadPayPortal();
      
      // Reset the toggle flag after a delay
      setTimeout(() => {
        isTogglingVendor = false;
        
        // Update settings display if on settings page
        const settingsSection = document.getElementById('settings-section');
        if (settingsSection.classList.contains('active')) {
          updateSettingsPage();
        }
        
        // After toggle completes, ensure container resizes properly with new content
        setTimeout(() => {
          if (balanceContainer) {
            // Force more accurate resize on mobile devices
            if (window.innerWidth < 768) {
              // Force a recalculation of the container size
              balanceContainer.style.height = 'auto';
              balanceContainer.style.minHeight = '0';
              
              // Show the container as loaded
              balanceContainer.classList.add('content-loaded');
              balanceContainer.classList.remove('loading');
              
              // Hide spinner
              const spinner = balanceContainer.querySelector('.balance-loading-spinner');
              if (spinner) {
                spinner.classList.remove('visible');
              }
              
              // Apply the adjustment
              adjustContainerSize(balanceContainer);
              
              // Second adjustment for when component is fully rendered
              setTimeout(() => {
                adjustContainerSize(balanceContainer);
              }, 1000);
            } else {
              adjustContainerSize(balanceContainer);
            }
          }
        }, 1000); // Shortened from 1500ms to 1000ms for faster response
      }, 1000);
    }

    // Load Balance Component
    async function loadBalance(showOnboarding = true) {
      // Prevent multiple simultaneous calls
      if (isLoadingBalance) return;
      
      isLoadingBalance = true;
      
      try {
        // Check if unipaas is available
        if (typeof unipaas === 'undefined') return;
        
        // Verify balance container exists
        const balanceContainer = document.getElementById("balance-dashboard");
        if (!balanceContainer) return;
        
        // Add loading class to container
        balanceContainer.classList.add('loading');
        // Remove content-loaded class during loading
        balanceContainer.classList.remove('content-loaded');
        
        // Show loading spinner
        const spinner = balanceContainer.querySelector('.balance-loading-spinner');
        if (spinner) {
          spinner.classList.add('visible');
        }
        
        // Prepare authorization payload
        let payload = { 
          scopes: ["portal_read", "portal_write"], 
          vendor: { reference: 'oded-test' } 
        };
        
        if (globalVendorId) {
          payload.vendorId = globalVendorId;
        }

        // Make authorization request
        const response = await fetch("https://sandbox.unipaas.com/platform/authorize", {
          method: "POST",
          headers: {
            "Accept": "application/json",
            "Content-Type": "application/json",
            "Authorization": "Bearer " + savedToken
          },
          body: JSON.stringify(payload)
        });
        
        if (!response.ok) return;
        
        const data = await response.json();
        
        // Clean up previous instance if it exists
        if (balanceInstance && typeof balanceInstance.unmount === "function") {
          balanceInstance.unmount();
          balanceContainer.innerHTML = "";
          
          // Re-add the spinner since we just cleared the container
          balanceContainer.innerHTML = `
            <div class="balance-loading-spinner visible">
              <div class="spinner"></div>
              <div class="spinner-text">Loading Balance</div>
            </div>
          `;
        }
        
        // Create new balance component
        if (!balanceComponents) {
          balanceComponents = unipaas.components(data.accessToken, unipaasDefaultConfig);
        } else {
          balanceComponents.reset({accessToken: data.accessToken});
        }
        
        balanceInstance = balanceComponents.create("balance");
        balanceInstance.mount("#balance-dashboard");
        
        // Set up a MutationObserver to detect when the Get Started or Start Now button appears
        const buttonObserver = new MutationObserver((mutations) => {
          const balanceElement = document.getElementById("balance-dashboard");
          if (balanceElement) {
            // Look for Get Started or Start Now buttons
            const onboardingBtn = Array.from(balanceElement.querySelectorAll('button')).find(
              btn => {
                const btnText = btn.textContent.trim().toUpperCase();
                return btnText === 'GET STARTED' || btnText === 'START NOW';
              }
            );
            
            if (onboardingBtn) {
              console.log(`Found ${onboardingBtn.textContent.trim()} button in balance component, attaching handler`);
              
              // Remove any existing handlers first
              onboardingBtn.removeEventListener('click', openOnboardingComponent);
              
              // Add direct click handler to the button
              onboardingBtn.addEventListener('click', function(e) {
                console.log(`Dashboard ${onboardingBtn.textContent.trim()} button clicked`);
                e.preventDefault();
                e.stopPropagation();
                openOnboardingComponent();
              });
              
              // We've found and attached to the button, no need to continue observing
              buttonObserver.disconnect();
              
              // Auto-open onboarding if no vendor ID is found and showOnboarding is true
              if (!globalVendorId && showOnboarding) {
                console.log("No vendor ID found, auto-opening onboarding");
                // Don't open immediately, wait a moment for UI to settle
                setTimeout(() => {
                  openOnboardingComponent();
                }, 1000);
              }
            }
          }
        });
        
        // Start observing the balance container for changes
        buttonObserver.observe(balanceContainer, { 
          childList: true, 
          subtree: true,
          attributes: true,
          characterData: true
        });
        
        // Set up a mutation observer to adjust the container size as content changes
        const observer = new MutationObserver((mutations) => {
          adjustContainerSize(balanceContainer);
        });
        
        observer.observe(balanceContainer, { 
          childList: true, 
          subtree: true, 
          attributes: true 
        });
        
        // Initial size adjustment (with a delay to allow content to render)
        setTimeout(() => {
          // Hide loading spinner
          const spinnerAfterLoad = balanceContainer.querySelector('.balance-loading-spinner');
          if (spinnerAfterLoad) {
            spinnerAfterLoad.classList.remove('visible');
          }
          
          adjustContainerSize(balanceContainer);
          balanceContainer.classList.remove('loading');
          // Add content-loaded class to remove minimum height constraint
          balanceContainer.classList.add('content-loaded');
        }, 1000);
        
      } catch (error) {
        console.error("Error loading balance component:", error);
        
        // Hide spinner on error
        const balanceContainer = document.getElementById("balance-dashboard");
        if (balanceContainer) {
          const spinner = balanceContainer.querySelector('.balance-loading-spinner');
          if (spinner) {
            spinner.classList.remove('visible');
          }
        }
      } finally {
        // Reset loading flag after a delay
        setTimeout(() => {
          isLoadingBalance = false;
        }, 1000);
      }
    }

    // Function to adjust container size based on content
    function adjustContainerSize(container) {
      if (!container) return;
      
      // Get all child elements
      const children = container.children;
      if (children.length === 0) return;
      
      // Get the first child (balance component)
      const component = children[0];
      
      // Set exact height based on component's content
      if (component) {
        // Force a reflow to get accurate measurements
        component.style.display = 'block';
        
        // Find the GET STARTED button if it exists
        const buttons = component.querySelectorAll('button');
        let getStartedButton = null;
        let lastVisibleElement = null;
        
        // First look for the GET STARTED button
        for (let i = 0; i < buttons.length; i++) {
          const buttonText = buttons[i].textContent.trim().toUpperCase();
          if (buttonText === 'GET STARTED') {
            getStartedButton = buttons[i];
            break;
          }
        }
        
        // If no GET STARTED button, find the last visible element
        if (!getStartedButton) {
          const allElements = component.querySelectorAll('*');
          for (let i = allElements.length - 1; i >= 0; i--) {
            const el = allElements[i];
            const style = window.getComputedStyle(el);
            const rect = el.getBoundingClientRect();
            
            if (style.display !== 'none' && 
                style.visibility !== 'hidden' && 
                rect.height > 0 && 
                rect.width > 0) {
              lastVisibleElement = el;
              break;
            }
          }
        }
        
        // Target element is either the button or last visible element
        const targetElement = getStartedButton || lastVisibleElement;
        
        if (targetElement) {
          // Measure to the bottom of the element plus a small margin
          const elementBottom = targetElement.getBoundingClientRect().bottom;
          const containerTop = container.getBoundingClientRect().top;
          const exactHeight = elementBottom - containerTop + 24; // Increased margin below for touch
          
          // Set fixed width for balance container across all screen sizes
          // but adjust for very small screens
          if (window.innerWidth < 480) {
            container.style.width = 'calc(100% - 16px)';
          } else if (window.innerWidth < 768) {
            container.style.width = '100%';
          } else {
            // On larger screens, always use the set max-width from CSS
            container.style.width = '100%';
          }
          
          // Apply the calculated height
          container.style.height = `${exactHeight}px`;
          
          // On mobile, ensure content is fully visible by adding a small delay
          if (window.innerWidth < 768) {
            setTimeout(() => {
              // Check if the content is still rendering and might need more height
              if (component.scrollHeight > container.offsetHeight) {
                container.style.height = `${component.scrollHeight + 24}px`;
              }
            }, 500);
          }
        } else if (component.offsetHeight > 0) {
          // If no target element found but component has height, use that plus a small margin
          container.style.height = `${component.offsetHeight + 24}px`;
        } else {
          // Default minimal height if nothing else works
          container.style.height = 'fit-content';
          container.style.minHeight = window.innerWidth < 768 ? '320px' : '0';
        }
      }
      
      // Add a resize observer to handle content changes
      if (!container.hasAttribute('resize-observer-added')) {
        container.setAttribute('resize-observer-added', 'true');
        
        try {
          const resizeObserver = new ResizeObserver(entries => {
            for (let entry of entries) {
              if (entry.target === component) {
                adjustContainerSize(container);
              }
            }
          });
          
          resizeObserver.observe(component);
          
          // Also observe changes to children
          const childObserver = new MutationObserver(() => {
            adjustContainerSize(container);
          });
          
          childObserver.observe(component, {
            childList: true,
            subtree: true,
            attributes: true,
            characterData: true
          });
          
        } catch (e) {
          console.log('ResizeObserver not supported in this browser');
        }
      }
    }

    // Load Pay Portal Component
    function loadPayPortal(isRefresh = false) {
      let payload = { scopes: ["portal_read", "portal_write"], vendor: { reference: 'oded-test' } };
      if (globalVendorId) {
        payload.vendorId = globalVendorId;
      }
      
      fetch("https://sandbox.unipaas.com/platform/authorize", {
        method: "POST",
        headers: {
          "Accept": "application/json",
          "Content-Type": "application/json",
          "Authorization": "Bearer " + savedToken
        },
        body: JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(data => {
        const newAccessToken = data.accessToken;
        
        // Create or reset components
        if (!balanceComponents) {
          balanceComponents = unipaas.components(newAccessToken, unipaasDefaultConfig);
        } else {
          balanceComponents.reset({ accessToken: newAccessToken });
        }
        
        // Create and mount payPortal
        if (payPortalInstance && typeof payPortalInstance.unmount === "function") {
          payPortalInstance.unmount();
        }
        
        payPortalInstance = balanceComponents.create("payPortal");
        payPortalInstance.mount("#pay_portal");
        payPortalLoaded = true;
        
        // Set up a MutationObserver to detect when the Get Started or Start Now button appears in pay portal
        const portalButtonObserver = new MutationObserver((mutations) => {
          const payPortalElement = document.getElementById("pay_portal");
          if (payPortalElement) {
            // Look for Get Started or Start Now button
            const onboardingBtn = Array.from(payPortalElement.querySelectorAll('button')).find(
              btn => {
                const btnText = btn.textContent.trim().toUpperCase();
                return btnText === 'GET STARTED' || btnText === 'START NOW';
              }
            );
            
            if (onboardingBtn) {
              console.log(`Found ${onboardingBtn.textContent.trim()} button in pay portal component, attaching handler`);
              
              // Remove any existing handlers first
              onboardingBtn.removeEventListener('click', openOnboardingComponent);
              
              // Add direct click handler to the button
              onboardingBtn.addEventListener('click', function(e) {
                console.log(`Pay Portal ${onboardingBtn.textContent.trim()} button clicked`);
                e.preventDefault();
                e.stopPropagation();
                openOnboardingComponent();
              });
              
              // Keep observing as pay portal buttons might be reloaded
            }
          }
        });
        
        // Get the pay portal container
        const payPortalContainer = document.getElementById("pay_portal");
        if (payPortalContainer) {
          // Start observing the pay portal container for changes
          portalButtonObserver.observe(payPortalContainer, { 
            childList: true, 
            subtree: true,
            attributes: true,
            characterData: true
          });
        }
      })
      .catch(err => console.error("Error fetching token:", err));
    }

    // Show tab function
    function showTab(tabId) {
      // Hide all sections
      const sections = document.querySelectorAll('.page-section');
      sections.forEach(section => section.classList.remove('active'));
      
      // Show the selected section
      const selectedSection = document.getElementById(`${tabId}-section`);
      if (selectedSection) {
        selectedSection.classList.add('active');
      }
      
      // Special handling for specific tabs
      if (tabId === 'payments') {
        // Load the pay portal if not already loaded
        if (!payPortalLoaded) {
          loadPayPortal();
        }
      } else if (tabId === 'dashboard') {
        // Ensure balance is loaded in dashboard
        const balanceContainer = document.getElementById("balance-dashboard");
        if (balanceContainer && balanceContainer.children.length === 0) {
          loadBalance();
        }
      } else if (tabId === 'settings') {
        // Update settings page with current values
        updateSettingsPage();
      }
    }
    
    // Function to update the settings page with current values
    function updateSettingsPage() {
      // Always show a vendor ID value
      const vendorIdInput = document.getElementById('vendorIdValue');
      if (vendorIdInput) {
        // If the toggle is off, we should display the default hardcoded vendor ID
        vendorIdInput.value = globalVendorId || "6847c40e23cb8d730cca6dbc";
      }
      
      // Update access token
      const accessTokenInput = document.getElementById('accessTokenValue');
      if (accessTokenInput) {
        accessTokenInput.value = latestAccessToken || savedToken;
      }
      
      // Update version number
      const versionNumberSpan = document.getElementById('versionNumber');
      if (versionNumberSpan) {
        versionNumberSpan.textContent = currentVersion;
      }
    }
    
    // Function to increment the version number - called whenever a change is made
    function incrementVersion() {
      currentVersion++;
      
      // Update the display if we're on the settings page
      const versionNumberSpan = document.getElementById('versionNumber');
      if (versionNumberSpan) {
        versionNumberSpan.textContent = currentVersion;
        
        // Add a brief flash animation
        const versionContainer = versionNumberSpan.parentElement;
        if (versionContainer) {
          versionContainer.style.backgroundColor = 'var(--success-color)'; // Brief green flash
          setTimeout(() => {
            versionContainer.style.backgroundColor = 'var(--primary-color)';
          }, 300);
        }
      }
      
      console.log(`Version incremented to: ${currentVersion}`);
    }
    
    // Function to copy text to clipboard
    function copyToClipboard(elementId) {
      const element = document.getElementById(elementId);
      if (!element) return;
      
      // Select the text
      element.select();
      element.setSelectionRange(0, 99999); // For mobile devices
      
      // Copy the text
      navigator.clipboard.writeText(element.value)
        .then(() => {
          // Show a brief success indication on the button
          const button = element.nextElementSibling;
          if (button) {
            const originalInnerHTML = button.innerHTML;
            button.innerHTML = '<i class="fa-solid fa-check"></i>';
            button.style.backgroundColor = 'var(--success-color)';
            
            // Restore the button after a short delay
            setTimeout(() => {
              button.innerHTML = originalInnerHTML;
              button.style.backgroundColor = 'var(--secondary-color)';
            }, 1000);
          }
        })
        .catch(err => {
          console.error('Failed to copy: ', err);
          alert('Failed to copy to clipboard');
        });
    }

    // Toggle plan submenu
    function togglePlanSubmenu(event) {
      event.preventDefault();
      const sub = document.getElementById('planSubmenu');
      sub.style.display = (sub.style.display === 'none') ? 'block' : 'none';
    }
    
    // Placeholder functions
    function dashboardCollectPayment() {
      // Set a flag to indicate we're coming from dashboard
      window.isDashboardPayment = true;
      
      // Open the payment modal
      openModal('paymentOptionModal');
      
      // Select the first product (Yoga Class) by default
      setTimeout(() => {
        const productSelect = document.getElementById('modalProductSelect');
        if (productSelect) {
          // Select the first option (Yoga Class)
          productSelect.selectedIndex = 0;
          
          // Update the amount input with the value of the selected product
          const amountInput = document.getElementById('modalAmountInput');
          if (amountInput && productSelect.options[0]) {
            amountInput.value = productSelect.options[0].value;
          }
        }
      }, 50);
    }
    
    function sendInvoiceReminder() {
      alert('Send AI Reminder functionality will be implemented later');
    }

    // Function to toggle card digits visibility
    function toggleCardDigits(button) {
      // Find the card digits element and asterisks
      const cardDigits = button.parentElement.querySelector('.card-digits');
      const asterisks = button.parentElement.querySelector('.asterisks');
      const eyeIcon = button.querySelector('i');
      
      // Toggle visibility
      if (cardDigits.classList.contains('hidden')) {
        // Show the digits
        cardDigits.classList.remove('hidden');
        cardDigits.classList.add('visible');
        
        // Hide the asterisks
        asterisks.style.display = 'none';
        
        // Change the eye icon
        eyeIcon.classList.remove('fa-eye');
        eyeIcon.classList.add('fa-eye-slash');
        
        // Hide after 5 seconds
        setTimeout(() => {
          // Show the asterisks again
          asterisks.style.display = '';
          
          // Hide the digits
          cardDigits.classList.remove('visible');
          cardDigits.classList.add('hidden');
          
          // Change the eye icon back
          eyeIcon.classList.remove('fa-eye-slash');
          eyeIcon.classList.add('fa-eye');
        }, 5000);
      }
    }
    
    // Function for online payments and card updates
    function createCheckout(paymentMethods, amount, customerEmail = "demo@example.com") {
      // Show loading overlay during checkout creation
      const loadingOverlay = document.getElementById("loadingOverlay");
      if (loadingOverlay) {
        loadingOverlay.style.display = "flex";
      }
      
      // Validate vendor ID
      if (!globalVendorId) {
        if (loadingOverlay) loadingOverlay.style.display = "none";
        alert("Please toggle 'Onboard' first to set up a vendor.");
        return;
      }
      
      // Generate unique reference
      const timestamp = Date.now();
      const reference = currentInvoiceId ? 
        `invoice_${currentInvoiceId}_${timestamp}` : 
        `checkout_${timestamp}`;
      
      // Build checkout data
      var data = {
        amount: amount,
        currency: "GBP",
        country: "GB",
        email: customerEmail,
        vendorId: globalVendorId,
        paymentMethods: paymentMethods,
        reference: reference,
        consumer: { 
          reference: `consumer_${timestamp}`,
          email: customerEmail
        }
      };
      
      // If this is for an invoice, add description
      if (currentInvoiceId) {
        const invoice = invoices.find(inv => inv.id === currentInvoiceId);
        if (invoice) {
          data.description = `Payment for invoice ${currentInvoiceId}`;
          // Store the invoice ID in metadata to retrieve later
          data.metadata = {
            invoiceId: currentInvoiceId,
            invoiceCustomer: invoice.customer
          };
        }
      }
      
      console.log("Creating checkout with data:", data);
      
      fetch("https://sandbox.unipaas.com/platform/pay-ins/checkout", {
        method: "POST",
        headers: getApiHeaders(),
        body: JSON.stringify(data)
      })
        .then(r => {
          if (!r.ok) {
            return r.json().then(errorData => {
              throw new Error(`Network error, status=${r.status}: ${JSON.stringify(errorData)}`);
            });
          }
          return r.json();
        })
        .then(jsonData => {
          // Hide loading overlay
          if (loadingOverlay) {
            loadingOverlay.style.display = "none";
          }
          
          console.log("Checkout created successfully:", jsonData);
          
          // Update the payment link modal
          document.getElementById('updatePaymentLink').textContent = jsonData.shortLink;
          document.getElementById('updatePaymentLink').href = jsonData.shortLink;
          document.getElementById('updatePaymentQRCode').src =
            "https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=" + encodeURIComponent(jsonData.shortLink);
          
          // Close the collect payment modal first
          closeModal('paymentOptionModal');
          
          // Open payment link modal
          openModal('updatePaymentModal');
          
          // Start the status timer
          startCheckoutStatusTimer(jsonData.id);
        })
        .catch(err => {
          // Hide loading overlay
          if (loadingOverlay) {
            loadingOverlay.style.display = "none";
          }
          
          console.error("Error in createCheckout:", err);
          alert("Error creating payment link: " + err.message);
        });
    }
    
    // Function to open payment link
    function openPaymentLink() {
      const paymentLink = document.getElementById('updatePaymentLink');
      if (paymentLink && paymentLink.href) {
        // Open in a new tab instead of the floating modal
        window.open(paymentLink.href, '_blank');
      }
    }
    
    // Function to open floating modal with payment link
    function openFloatingModal(link) {
      const iframe = document.getElementById("previewIframe");
      const modal = document.getElementById("floatingPreviewModal");
      
      if (!iframe || !modal) return;
      
      // Set the link to the iframe
      iframe.src = link;
      iframe.scrolling = "auto";
      
      // Display modal with flex to center content
      modal.style.display = "flex";
      modal.style.alignItems = "center";
      modal.style.justifyContent = "center";
      
      // Add class to document body to prevent scrolling
      document.body.classList.add('preview-active');
      document.body.style.overflow = 'hidden';
      
      // For mobile devices, adjust modal positioning
      if (window.innerWidth <= 767) {
        modal.style.padding = "0";
        
        // Give the iframe a moment to load before scrolling to top
        setTimeout(() => {
          if (iframe.contentWindow) {
            iframe.contentWindow.scrollTo(0, 0);
          }
        }, 300);
      }
    }
    
    // Function to close floating modal
    function closeFloatingModal() {
      const modal = document.getElementById("floatingPreviewModal");
      const iframe = document.getElementById("previewIframe");
      
      if (!modal || !iframe) return;
      
      // Hide modal
      modal.style.display = "none";
      
      // Clear iframe content after a slight delay to prevent issues on some browsers
      setTimeout(() => {
        iframe.src = "";
      }, 100);
      
      // Remove class from document body and restore scrolling
      document.body.classList.remove('preview-active');
      document.body.style.overflow = '';
      
      // Return modal padding to default for next time
      if (window.innerWidth <= 767) {
        modal.style.removeProperty('padding');
      }
    }
    
    // Poll for checkout status
    let checkoutStatusTimer = null;
    
    function startCheckoutStatusTimer(checkoutId) {
      // Validate checkout ID
      if (!checkoutId) {
        console.error("Cannot start timer: Invalid checkout ID");
        return;
      }

      console.log("Starting checkout status timer for ID:", checkoutId);
      
      // Clear any existing timer
      if (checkoutStatusTimer) {
        clearInterval(checkoutStatusTimer);
      }
      
      // Start with the current time to handle timeouts
      const startTime = Date.now();
      
      // Start a new timer
      checkoutStatusTimer = setInterval(() => {
        // Check for timeout (after 400 seconds)
        const elapsed = (Date.now() - startTime) / 1000;
        if (elapsed > 400) {
          console.log("Checkout status check timed out after 400 seconds");
          clearInterval(checkoutStatusTimer);
          return;
        }
        
        // Log that we're checking status
        console.log("Checking checkout status for ID:", checkoutId);
        
        fetch(`https://sandbox.unipaas.com/platform/pay-ins/checkout/${checkoutId}`, {
          method: "GET",
          headers: getApiHeaders()
        })
          .then(r => {
            // Handle response errors
            if (!r.ok) {
              throw new Error(`Status check failed with status: ${r.status}`);
            }
            return r.json();
          })
          .then(data => {
            console.log('Checkout status response:', data);
            
            // Check if checkout completed - checking for "paid" status
            if (data.status && data.status.toLowerCase() === 'paid') {
              console.log("Payment completed successfully!");
              
              // Stop polling
              clearInterval(checkoutStatusTimer);
              
              // If this was an invoice payment, update the invoice status
              if (currentInvoiceId) {
                console.log(`Online payment completed for invoice ${currentInvoiceId}, updating status to Paid`);
                const invoice = invoices.find(inv => inv.id === currentInvoiceId);
                if (invoice) {
                  invoice.status = 'Paid';
                  updateInvoicesTable();
                  updateOverdueInvoicesCount();
                }
              } else if (data.metadata && data.metadata.invoiceId) {
                // Handle case where payment was for an invoice but currentInvoiceId was lost
                console.log(`Payment for invoice ${data.metadata.invoiceId} from metadata, updating status`);
                const invoice = invoices.find(inv => inv.id === data.metadata.invoiceId);
                if (invoice) {
                  invoice.status = 'Paid';
                  updateInvoicesTable();
                  updateOverdueInvoicesCount();
                }
              }
              
              // Close modals
              closeModal('paymentOptionModal');
              closeModal('updatePaymentModal');
              closeFloatingModal();
              
              // Get amount from checkout data
              const amount = data.amount || 'unknown';
              
              // Show success modal instead of alert
              setTimeout(() => {
                showSuccessModal(amount);
              }, 500);
            }
          })
          .catch(err => {
            console.error('Error checking checkout status:', err);
          });
      }, 5000); // Check every 5 seconds
    }
    
    function openSendMandateModal(customerName, customerEmail) {
      // Initialize loading indicator for QR code
      const loadingOverlay = document.getElementById("loadingOverlay");
      if (loadingOverlay) {
        loadingOverlay.style.display = "flex";
      }
      
      // Send the mandate request first
      sendMandate(customerName, customerEmail);
      
      // Don't open the modal yet - it will be opened after we get the link
    }
    
    function sendMandate(customerName, customerEmail) {
      if (!globalVendorId) {
        alert("No vendor selected. Please toggle 'Onboard' first!");
        return;
      }
      
      const payload = {
        consumer: {
          name: customerName || "Member Name",
          email: customerEmail || "member@example.com",
          reference: "member-" + Date.now()
        },
        createMandateLink: true
      };
      
      fetch(`https://sandbox.unipaas.com/platform/vendors/${globalVendorId}/mandates`, {
        method: "POST",
        headers: getApiHeaders(),
        body: JSON.stringify(payload)
      })
      .then(response => {
        if (!response.ok) throw new Error("Error, status=" + response.status);
        return response.json();
      })
      .then(data => {
        const link = data.link.url;
        
        // Hide loading overlay
        const loadingOverlay = document.getElementById("loadingOverlay");
        if (loadingOverlay) {
          loadingOverlay.style.display = "none";
        }
        
        // Setup mandate link and QR code
        const mandateLink = document.getElementById('mandateLink');
        mandateLink.textContent = link;
        mandateLink.href = link;
        
        // Create a new image and only set it as the QR code source once it's loaded
        const img = new Image();
        img.onload = function() {
          document.getElementById('mandateQRCode').src = img.src;
          
          // Now that everything is ready, open the modal
          const modal = document.getElementById('mandateModal');
          if (modal) {
            modal.classList.add('active');
            modal.style.display = 'flex';
          }
        };
        img.src = "https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=" + encodeURIComponent(link);
      })
      .catch(e => {
        console.error("sendMandate error:", e);
        
        // Hide loading overlay
        const loadingOverlay = document.getElementById("loadingOverlay");
        if (loadingOverlay) {
          loadingOverlay.style.display = "none";
        }
        
        alert("Error creating mandate: " + e.message);
      });
    }
    
    function copyMandateQRCode() {
      var mandateLink = document.getElementById('mandateLink');
      if (mandateLink && mandateLink.href && mandateLink.href !== '#') {
        window.open(mandateLink.href, '_blank');
        
        // Change button text to indicate link was opened
        var copyQRBtn = document.querySelector('#mandateModal .copy-qr-btn');
        if (copyQRBtn) {
          const originalText = copyQRBtn.textContent;
          copyQRBtn.textContent = 'Link Opened';
          
          // Reset button text after 2 seconds
          setTimeout(() => {
            copyQRBtn.textContent = originalText;
          }, 2000);
        }
      } else {
        alert('No mandate link available yet.');
      }
    }

    // Function to handle collecting payment for a product
    function openPaymentModalWithProduct(productName, price) {
      // Set flag to indicate we're coming from the store page
      window.comingFromStore = true;
      
      // Open the payment modal
      openModal('paymentOptionModal');
      
      // After opening, select the right product in the dropdown
      setTimeout(() => {
        const productSelect = document.getElementById('modalProductSelect');
        const amountInput = document.getElementById('modalAmountInput');
        
        if (productSelect && amountInput) {
          // Find the option that matches our product name
          for (let i = 0; i < productSelect.options.length; i++) {
            if (productSelect.options[i].text === productName) {
              productSelect.selectedIndex = i;
              break;
            }
          }
          
          // Set the amount
          amountInput.value = price;
        }
        
        // Clear the flag (to prevent it affecting other modal openings)
        window.comingFromStore = false;
      }, 50);
    }
    
    // Function to update amount when product changes
    function updateModalProductAmount() {
      const productSelect = document.getElementById('modalProductSelect');
      const amountInput = document.getElementById('modalAmountInput');
      
      if (productSelect && amountInput) {
        amountInput.value = productSelect.value;
      }
    }
    
    // Function to handle modal open
    function openModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.add('active');
        modal.style.display = 'flex';
        
        // Initialize payment modal if it's the payment option modal
        if (modalId === 'paymentOptionModal') {
          // Reset to first product if not coming from store page or dashboard
          if (!window.comingFromStore && !window.isDashboardPayment) {
            const productSelect = document.getElementById('modalProductSelect');
            const amountInput = document.getElementById('modalAmountInput');
            
            if (productSelect && amountInput) {
              // Reset to first product
              productSelect.selectedIndex = 0;
              amountInput.value = productSelect.value;
            }
          }
          
          // Dashboard payments now handled in dashboardCollectPayment function
          
          // Set default tab to Terminal
          const terminalTab = document.querySelector('.payment-tab[data-tab="terminal"]');
          if (terminalTab) {
            switchPaymentTab(terminalTab, 'terminal');
          }
          
          // Initialize saved card info based on selected customer
          updateSavedCardInfo();
          
          // For mobile view, make sure the custom dropdown is visible
          if (window.innerWidth <= 767) {
            const methodSelector = document.querySelector('.payment-method-selector');
            if (methodSelector) {
              methodSelector.style.display = 'block';
            }
          }
          
          // Always initialize custom dropdown for mobile
          setTimeout(() => {
            initCustomDropdown();
            
            // On mobile, ensure the first option is correctly selected in the dropdown
            if (window.innerWidth <= 767) {
              const selectedOption = document.querySelector('.selected-option');
              if (selectedOption) {
                selectedOption.innerHTML = '<i class="fa-solid fa-cash-register" style="margin-right: 8px;"></i><span>Terminal</span>';
              }
              
              // Ensure dropdown is properly positioned
              const dropdownOptions = document.querySelector('.dropdown-options');
              if (dropdownOptions) {
                dropdownOptions.style.display = 'none';
              }
            }
          }, 100);
        }
      }
    }
    
    // Function to handle modal close
    function closeModal(modalId) {
      // Reset flags when payment modal is closed
      if (modalId === 'paymentOptionModal') {
        window.comingFromStore = false;
        window.isDashboardPayment = false;
        
        // Restore original product div and customer select if they were modified for invoice payment
        if (window.originalProductDiv) {
          const productDiv = document.querySelector('.product-amount-row div:first-child');
          if (productDiv) {
            productDiv.innerHTML = window.originalProductDiv;
          }
        }
        
        const amountInput = document.getElementById('modalAmountInput');
        if (amountInput) {
          amountInput.readOnly = false;
          amountInput.style.backgroundColor = "";
          amountInput.style.color = "";
        }
        
        if (window.originalCustomerSelect) {
          const customerDiv = document.querySelector('#customerSelect').parentNode;
          if (customerDiv) {
            customerDiv.innerHTML = window.originalCustomerSelect;
            // Re-attach change handler to the new select element
            document.getElementById('customerSelect').addEventListener('change', updateSavedCardInfo);
          }
        }
        
        // Only reset current invoice ID if success modal is not active
        // This ensures currentInvoiceId remains available for the success modal
        const successModal = document.getElementById('successModal');
        if (!successModal || !successModal.classList.contains('active')) {
          console.log(`Resetting currentInvoiceId (was: ${currentInvoiceId})`);
          currentInvoiceId = null;
        } else {
          console.log(`Preserving currentInvoiceId: ${currentInvoiceId} for success processing`);
        }
      }
      
      // Clear checkout status timer when closing the payment link modal
      if (modalId === 'updatePaymentModal') {
        if (checkoutStatusTimer) {
          clearInterval(checkoutStatusTimer);
          checkoutStatusTimer = null;
        }
      }
      
      // Reset invoice ID when closing success modal
      if (modalId === 'successModal') {
        console.log(`Closing success modal, final reset of currentInvoiceId: ${currentInvoiceId}`);
        currentInvoiceId = null;
      }
      
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.remove('active');
        modal.style.display = 'none';
      }
    }

    // Function to update saved card info based on selected customer
    function updateSavedCardInfo() {
      const customerSelect = document.getElementById('customerSelect');
      if (!customerSelect) return;
      
      const selectedValue = customerSelect.value;
      const cardTypeNumber = document.getElementById('card-type-number');
      const cardExpiry = document.getElementById('card-expiry');
      
      if (!cardTypeNumber || !cardExpiry) return;
      
      // Different card info for each customer
      if (selectedValue === 'john') {
        cardTypeNumber.textContent = 'Mastercard ending in 5032';
        cardExpiry.textContent = 'Expires 04/28';
      } else if (selectedValue === 'oded') {
        cardTypeNumber.textContent = 'Visa ending in 4321';
        cardExpiry.textContent = 'Expires 09/28';
      }
    }
    
    // Function to switch between payment tabs
    function switchPaymentTab(tabElement, tabName) {
      // Update active tab styling
      const allTabs = document.querySelectorAll('.payment-tab');
      allTabs.forEach(tab => {
        tab.classList.remove('active');
        tab.style.borderBottom = 'none';
      });
      
      tabElement.classList.add('active');
      tabElement.style.borderBottom = '2px solid var(--primary-color)';
      
      // Update dropdown selection to match (for mobile)
      const dropdown = document.getElementById('paymentMethodDropdown');
      if (dropdown) {
        dropdown.value = tabName;
      }
      
      // Hide all tab panes
      const allPanes = document.querySelectorAll('.tab-pane');
      allPanes.forEach(pane => {
        pane.style.display = 'none';
      });
      
      // Show selected tab pane
      document.getElementById(tabName + '-tab').style.display = 'block';
      
      // Update action button text and onclick handler based on selected tab
      const actionButton = document.getElementById('paymentActionButton');
      
      if (tabName === 'terminal') {
        actionButton.textContent = 'Pay by Terminal';
        actionButton.onclick = function() { onPayWithTerminbalClick('terminalPaymentModal'); };
      } else if (tabName === 'saved-card') {
        actionButton.textContent = 'Charge Saved Card';
        actionButton.onclick = function() { chargeSavedCard(); };
      } else if (tabName === 'online') {
        actionButton.textContent = 'Create Payment Link';
        actionButton.onclick = function() { 
          // Check if TFC is selected
          const tfcChecked = document.getElementById('checkoutOptionTFC').checked;
          
          if (tfcChecked) {
            // Close the collect payment modal first
            closeModal('paymentOptionModal');
            
            // Open TFC checkout modal instead of payment link modal
            openTFCCheckoutModal();
            
            return; // Exit early, don't create checkout
          }
          
          // Original logic for non-TFC payments
          // Get selected payment methods
          const paymentMethods = [];
          
          // Add selected payment methods
          if (document.getElementById('checkoutOptionCards').checked) {
            paymentMethods.push('card');
          }
          
          if (document.getElementById('checkoutOptionOpenBanking').checked) {
            paymentMethods.push('bankTransfer'); // Changed from 'openBanking' to 'bankTransfer'
          }
          
          // Validate that at least one payment method is selected
          if (paymentMethods.length === 0) {
            alert('Please select at least one payment method');
            return;
          }
          
          // Get amount value
          const amountInput = document.getElementById('modalAmountInput');
          const amountValue = parseFloat(amountInput.value);
          
          // Validate amount
          if (!amountValue || isNaN(amountValue) || amountValue <= 0) {
            alert('Please enter a valid amount');
            return;
          }
          
          // Check if we have a vendor ID
          if (!globalVendorId) {
            alert("Please toggle 'Onboard' switch at the top-right to set up a vendor first");
            return;
          }
          
          // Get customer information from the select
          const customerSelect = document.getElementById('customerSelect');
          let customerEmail = "john.mitch@gmail.com";
          
          if (customerSelect.value === 'oded') {
            customerEmail = "oded.kovach@gmail.com";
          }
          
          console.log("Creating payment link with methods:", paymentMethods, "amount:", amountValue);
          
          // Check if we're processing an invoice
          if (currentInvoiceId) {
            console.log(`Creating online payment for invoice: ${currentInvoiceId}`);
          }
          
          // Create checkout with payment methods and amount
          createCheckout(paymentMethods, amountValue, customerEmail);
        };
      } else if (tabName === 'direct-debit') {
        actionButton.textContent = 'Set Up Direct Debit';
        actionButton.onclick = function() { handleDirectDebitSubmit(); };
      }
    }
    
    // Initialize custom dropdown for payment methods on mobile
    function initCustomDropdown() {
      // Only set up mobile-specific functionality if actually on mobile
      if (window.innerWidth <= 767) {
        // Remove any existing event listeners first to prevent duplicates
        const selectorButton = document.querySelector('.selector-button');
        if (!selectorButton) return;
        
        // Clone the element to remove all existing event listeners
        const newSelectorButton = selectorButton.cloneNode(true);
        selectorButton.parentNode.replaceChild(newSelectorButton, selectorButton);
        
        // Add fresh event listener to open bottom sheet
        newSelectorButton.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          openBottomSheet();
        });
        
        // Make sure payment method selector is visible on mobile
        const methodSelector = document.querySelector('.payment-method-selector');
        if (methodSelector) {
          methodSelector.style.display = 'block';
        }
        
        // Add event listener to bottom sheet backdrop
        const backdrop = document.getElementById('paymentOptionsBackdrop');
        if (backdrop) {
          // Clone to remove existing listeners
          const newBackdrop = backdrop.cloneNode(true);
          backdrop.parentNode.replaceChild(newBackdrop, backdrop);
          
          newBackdrop.addEventListener('click', closeBottomSheet);
        }
      }
    }
    
    // Function to open the bottom sheet
    function openBottomSheet() {
      // Only activate on mobile
      if (window.innerWidth > 767) return;
      
      const backdrop = document.getElementById('paymentOptionsBackdrop');
      const bottomSheet = document.getElementById('paymentOptionsSheet');
      
      if (backdrop && bottomSheet) {
        backdrop.classList.add('active');
        bottomSheet.classList.add('active');
        
        // Rotate chevron icon to indicate open state
        const chevron = document.querySelector('.selector-button i.fa-chevron-up');
        if (chevron) {
          chevron.style.transform = 'rotate(0deg)';
        }
      }
    }
    
    // Function to close the bottom sheet
    function closeBottomSheet() {
      // Check if we need to do anything (only relevant on mobile)
      if (window.innerWidth > 767) return;
      
      const backdrop = document.getElementById('paymentOptionsBackdrop');
      const bottomSheet = document.getElementById('paymentOptionsSheet');
      
      if (backdrop && bottomSheet) {
        backdrop.classList.remove('active');
        bottomSheet.classList.remove('active');
        
        // Rotate chevron icon back to indicate closed state
        const chevron = document.querySelector('.selector-button i.fa-chevron-up');
        if (chevron) {
          chevron.style.transform = 'rotate(180deg)';
        }
      }
    }
    
    // Function to select a payment option from the bottom sheet
    function selectPaymentOption(optionElement, value) {
      // Only handle special mobile behavior if on mobile
      if (window.innerWidth <= 767) {
        // Update selected option in bottom sheet
        const allOptions = document.querySelectorAll('.bottom-sheet-option');
        allOptions.forEach(option => {
          option.classList.remove('selected');
        });
        
        optionElement.classList.add('selected');
        
        // Update the selector button text and icon
        const selectedOption = document.querySelector('.selected-option');
        if (selectedOption) {
          let iconClass = 'fa-cash-register';
          let optionText = 'Terminal';
          
          if (value === 'saved-card') {
            iconClass = 'fa-credit-card';
            optionText = 'Saved Card';
          } else if (value === 'online') {
            iconClass = 'fa-globe';
            optionText = 'Online';
          } else if (value === 'direct-debit') {
            iconClass = 'fa-university';
            optionText = 'Direct Debit';
          }
          
          selectedOption.innerHTML = `<i class="fa-solid ${iconClass}" style="margin-right: 8px;"></i><span>${optionText}</span>`;
        }
        
        // Close the bottom sheet
        closeBottomSheet();
      }
      
      // This part should happen for all views
      switchPaymentTab(document.querySelector(`.payment-tab[data-tab="${value}"]`), value);
    }

    // Function to handle terminal payment
    function onPayWithTerminbalClick(modalId) {
      const maxAttempts = 30;
      let attempts = 0;

      openModal(modalId);
      
      // Get amount from product selection
      let amount;
      var select = document.getElementById('modalProductSelect');
      amount = parseFloat(select.value);
      
      if (!amount || isNaN(amount)) {
        alert("Invalid amount for terminal payment");
        closeModal(modalId);
        return;
      }

      const data = {
        amount: amount,
        currency: "GBP",
        country: "GB",
        vendorId: globalVendorId,
        reference: "order-" + new Date().getTime(),
        transactionType: "Sale",
        paymentOption: {
          paymentOptionType: "CardPresent"
        },
        consumer: {
          firstName: "John",
          lastName: "Mitch",
          email: "John.mitch@gmail.com",
          country: "GB"
        }
      }

      let authorizationId = "";
      
      // Update terminal status to show we're connecting to terminal
      const terminalStatus = document.getElementById('terminalStatus');
      if (terminalStatus) {
        terminalStatus.textContent = "Waiting for payment...";
      }

      fetch(`https://sandbox.unipaas.com/platform/pay-ins`, {
        method: "POST",
        headers: getApiHeaders(),
        body: JSON.stringify(data)
      })
        .then(r => r.json())
        .then(jsonData => {
          authorizationId = jsonData.authorizationId;
          
          // Update terminal status to show it's ready for payment
          if (terminalStatus) {
            terminalStatus.textContent = "Terminal ready. Please tap, insert, or swipe card...";
          }

          const interval = setInterval(() => {
            attempts++;
            if(attempts === maxAttempts) {
              clearInterval(interval);
              closeModal('terminalPaymentModal');
              closeModal('paymentOptionModal');
              
              // Show timeout message
              alert("Terminal payment timed out. Please try again.");
            }

            fetch(`https://sandbox.unipaas.com/platform/pay-ins/${authorizationId}`,
              {
                headers: getApiHeaders(),
                method: "GET"
              }
            )
              .then(response => response.json())
              .then(data => {
                console.log('Received data:', data);
                
                // Update status based on terminal response
                if (terminalStatus) {
                  if (data.authorizationStatus === 'Pending') {
                    terminalStatus.textContent = "Processing payment...";
                  } else if (data.authorizationStatus === 'Captured') {
                    terminalStatus.textContent = "Payment approved!";
                  } else if (data.authorizationStatus === 'Failed') {
                    terminalStatus.textContent = "Payment failed. Please try again.";
                  }
                }
                
                if (data.authorizationStatus === 'Captured') {
                  clearInterval(interval);
                  
                  // Show success UI
                  const terminalSpinner = document.getElementById('terminalSpinner');
                  const terminalSuccess = document.getElementById('terminalSuccess');
                  const successMessage = document.getElementById('successMessage');
                  
                  if (terminalSpinner && terminalSuccess) {
                    // Hide the spinner
                    terminalSpinner.style.display = 'none';
                    
                    // Update success message if needed
                    if (successMessage) {
                      successMessage.textContent = "Payment successful";
                    }
                    
                    // Show the success UI
                    terminalSuccess.style.display = 'block';
                    
                    console.log("Payment successful, showing success UI");
                  }
                  
                  // Close modals after success (after 2.5 seconds for better UX)
                  setTimeout(() => {
                    console.log("Closing modals after successful payment");
                    closeModal('terminalPaymentModal');
                    closeModal('paymentOptionModal');
                    
                    // Show success modal instead of alert
                    showSuccessModal(amount);
                  }, 2500);
                } else if (data.authorizationStatus === 'Failed') {
                  clearInterval(interval);
                  
                  // Close modals after failure
                  setTimeout(() => {
                    closeModal('terminalPaymentModal');
                    
                    // Show failure message
                    alert("Payment failed. Please try again.");
                  }, 1000);
                }
              })
              .catch(error => {
                console.error('Error fetching terminal status:', error);
              });
          }, 5000); // Check status every 5 seconds
        })
        .catch(e => {
          console.error("Terminal payment error:", e);
          
          // Update status and close modals on error
          if (terminalStatus) {
            terminalStatus.textContent = "Error connecting to terminal";
          }
          
          setTimeout(() => {
            closeModal('terminalPaymentModal');
            alert("Error connecting to payment terminal. Please try again.");
          }, 1000);
        });
    }

    // Show success modal with amount
    function showSuccessModal(amount) {
      // Format amount to 2 decimal places if it's a number
      const formattedAmount = typeof amount === 'number' ? amount.toFixed(2) : amount;
      
      // Update the success message with the amount
      const successAmountElement = document.getElementById('successAmount');
      if (successAmountElement) {
        successAmountElement.innerHTML = `Your payment of <span style="font-weight: 600; color: #9CAF3F;">£${formattedAmount}</span> has been processed.`;
      }
      
      // If payment was for an invoice, mark it as paid
      if (currentInvoiceId) {
        const invoice = invoices.find(inv => inv.id === currentInvoiceId);
        if (invoice) {
          console.log(`Updating invoice ${currentInvoiceId} status from ${invoice.status} to Paid`);
          invoice.status = 'Paid';
          
          // Update invoices table
          updateInvoicesTable();
          
          // Update dashboard count of overdue invoices
          updateOverdueInvoicesCount();
          
          // Force a redraw of the table by adding a small delay
          setTimeout(() => {
            console.log('Refreshing invoice table display');
            updateInvoicesTable();
          }, 500);
        } else {
          console.error(`Could not find invoice with ID: ${currentInvoiceId}`);
        }
      }
      
      // Display the modal
      const modal = document.getElementById('successModal');
      if (modal) {
        modal.style.display = 'flex';
        modal.classList.add('active');
      }
      
      // Add animation class to body
      document.body.classList.add('modal-open');
    }
    
    // Update the count of overdue invoices on dashboard
    function updateOverdueInvoicesCount() {
      const overdueCount = invoices.filter(inv => 
        inv.status !== 'Paid' && 
        new Date(inv.dueDate.split('/').reverse().join('-')) < new Date()
      ).length;
      
      const overdueCountElement = document.querySelector('#dashboard-section .card:nth-child(2) .value');
      if (overdueCountElement) {
        overdueCountElement.textContent = overdueCount;
      }
    }
    
    // Function to handle saved card payment
    function chargeSavedCard() {
      // Get amount from product selection
      const amountInput = document.getElementById('modalAmountInput');
      const amount = parseFloat(amountInput.value);
      
      if (!amount || isNaN(amount) || amount <= 0) {
        alert("Please enter a valid amount");
        return;
      }
      
      // Check if we have a vendor ID
      if (!globalVendorId) {
        alert("Please toggle 'Onboard' switch at the top-right to set up a vendor first");
        return;
      }
      
      // Check and log if we're processing an invoice payment
      if (currentInvoiceId) {
        console.log(`Processing saved card payment for invoice: ${currentInvoiceId}`);
      }
      
      // Get customer information
      const customerSelect = document.getElementById('customerSelect');
      const selectedCustomer = customerSelect.value;
      let customerEmail = "john.mitch@gmail.com";
      let customerName = "John Mitch";
      
      // Set payment option ID based on selected customer
      let paymentOptionId = "67a3759c2d2d4420a8b7842f"; // Default ID for John's card
      
      if (selectedCustomer === 'oded') {
        customerEmail = "oded.kovach@gmail.com";
        customerName = "Oded Kovach";
        paymentOptionId = "67a37abf2d2d4520a8b78433"; // ID for Oded's card
      }
      
      // Get and modify the button to show spinner
      const actionButton = document.getElementById('paymentActionButton');
      const originalButtonText = actionButton.textContent;
      actionButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin" style="margin-right: 8px;"></i>Processing...';
      actionButton.disabled = true;
      
      // Prepare payment data using the correct structure from v62
      const payload = {
        amount: amount,
        currency: "GBP",
        description: "Saved Card Payment",
        vendorId: globalVendorId,
        paymentOptionId: paymentOptionId,
        orderId: `saved_card_payment_${Date.now()}`,
        consumer: {
          email: customerEmail,
          firstName: customerName.split(' ')[0],
          lastName: customerName.split(' ')[1] || '',
          country: "GB"
        }
      };
      
      console.log("Making saved card payment request:", payload);
      
      // Make the API call
      fetch("https://sandbox.unipaas.com/platform/pay-ins", {
        method: "POST",
        headers: getApiHeaders(),
        body: JSON.stringify(payload)
      })
      .then(response => {
        if (!response.ok) {
          throw new Error("Network response was not OK, status = " + response.status);
        }
        return response.json();
      })
      .then(jsonData => {
        console.log("Payment Request Successful:", jsonData);
        
        // Restore button state
        actionButton.innerHTML = originalButtonText;
        actionButton.disabled = false;
        
        if (jsonData.transactionStatus === "Approved") {
          // If this is an invoice payment, make sure we update the invoice in memory
          if (currentInvoiceId) {
            const invoice = invoices.find(inv => inv.id === currentInvoiceId);
            if (invoice) {
              console.log(`Saved card payment successful, marking invoice ${currentInvoiceId} as paid`);
              invoice.status = 'Paid';
              // Update table immediately to ensure it's refreshed
              updateInvoicesTable();
            }
          }
          
          // Close payment modal
          closeModal('paymentOptionModal');
          
          // Show success modal
          showSuccessModal(amount);
        } else {
          alert("Payment failed: " + (jsonData.message || "Unknown error"));
        }
      })
      .catch(error => {
        console.error("Error in Payment Request:", error);
        
        // Restore button state
        actionButton.innerHTML = originalButtonText;
        actionButton.disabled = false;
        
        // Show error message
        alert("Payment failed: " + error.message);
      });
    }
    
    // Function to handle direct debit submission
    function handleDirectDebitSubmit() {
      // Get customer information
      const customerSelect = document.getElementById('customerSelect');
      const selectedCustomer = customerSelect.value;
      let customerEmail = "john.mitch@gmail.com";
      let customerName = "John Mitch";
      
      if (selectedCustomer === 'oded') {
        customerEmail = "oded.kovach@gmail.com";
        customerName = "Oded Kovach";
      }
      
      // Close payment modal and open mandate modal
      closeModal('paymentOptionModal');
      openSendMandateModal(customerName, customerEmail);
    }
    
    // Create sample invoices for the tables
    function createSampleInvoices() {
      // Clear existing invoices
      invoices = [];
      
      // Get current date
      const today = new Date();
      
      // Create dates for invoices
      const createDateString = (date) => {
        return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
      };
      
      // Generate 10 sample invoices
      const sampleInvoices = [
        {
          id: 'INV-2023-001',
          customer: 'John Mitch',
          customerEmail: 'john.mitch@gmail.com',
          amount: '550.00',
          date: createDateString(today),
          dueDate: createDateString(new Date(today.getTime() + 14 * 24 * 60 * 60 * 1000)), // Due in 14 days
          status: 'Unpaid' // First one is unpaid
        },
        {
          id: 'INV-2023-002',
          customer: 'Oded Kovach',
          customerEmail: 'oded.kovach@gmail.com',
          amount: '175.50',
          date: createDateString(new Date(today.getTime() - 5 * 24 * 60 * 60 * 1000)), // 5 days ago
          dueDate: createDateString(new Date(today.getTime() + 9 * 24 * 60 * 60 * 1000)), // Due in 9 days
          status: 'Paid'
        },
        {
          id: 'INV-2023-003',
          customer: 'Sarah Johnson',
          customerEmail: 'sjohnson@example.com',
          amount: '320.75',
          date: createDateString(new Date(today.getTime() - 10 * 24 * 60 * 60 * 1000)), // 10 days ago
          dueDate: createDateString(new Date(today.getTime() + 4 * 24 * 60 * 60 * 1000)), // Due in 4 days
          status: 'Paid'
        },
        {
          id: 'INV-2023-004',
          customer: 'David Williams',
          customerEmail: 'dwilliams@example.com',
          amount: '99.99',
          date: createDateString(new Date(today.getTime() - 15 * 24 * 60 * 60 * 1000)), // 15 days ago
          dueDate: createDateString(new Date(today.getTime() - 1 * 24 * 60 * 60 * 1000)), // Due yesterday
          status: 'Paid'
        },
        {
          id: 'INV-2023-005',
          customer: 'Emma Thompson',
          customerEmail: 'ethompson@example.com',
          amount: '450.00',
          date: createDateString(new Date(today.getTime() - 20 * 24 * 60 * 60 * 1000)), // 20 days ago
          dueDate: createDateString(new Date(today.getTime() - 6 * 24 * 60 * 60 * 1000)), // Due 6 days ago
          status: 'Paid'
        },
        {
          id: 'INV-2023-006',
          customer: 'Michael Brown',
          customerEmail: 'mbrown@example.com',
          amount: '199.50',
          date: createDateString(new Date(today.getTime() - 25 * 24 * 60 * 60 * 1000)), // 25 days ago
          dueDate: createDateString(new Date(today.getTime() - 11 * 24 * 60 * 60 * 1000)), // Due 11 days ago
          status: 'Paid'
        },
        {
          id: 'INV-2023-007',
          customer: 'Jessica Lee',
          customerEmail: 'jlee@example.com',
          amount: '275.25',
          date: createDateString(new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000)), // 30 days ago
          dueDate: createDateString(new Date(today.getTime() - 16 * 24 * 60 * 60 * 1000)), // Due 16 days ago
          status: 'Paid'
        },
        {
          id: 'INV-2023-008',
          customer: 'Robert Garcia',
          customerEmail: 'rgarcia@example.com',
          amount: '150.00',
          date: createDateString(new Date(today.getTime() - 35 * 24 * 60 * 60 * 1000)), // 35 days ago
          dueDate: createDateString(new Date(today.getTime() - 21 * 24 * 60 * 60 * 1000)), // Due 21 days ago
          status: 'Paid'
        },
        {
          id: 'INV-2023-009',
          customer: 'Jennifer Wilson',
          customerEmail: 'jwilson@example.com',
          amount: '399.99',
          date: createDateString(new Date(today.getTime() - 40 * 24 * 60 * 60 * 1000)), // 40 days ago
          dueDate: createDateString(new Date(today.getTime() - 26 * 24 * 60 * 60 * 1000)), // Due 26 days ago
          status: 'Paid'
        },
        {
          id: 'INV-2023-010',
          customer: 'Oded Kovach',
          customerEmail: 'oded.kovach@gmail.com',
          amount: '225.50',
          date: createDateString(new Date(today.getTime() - 45 * 24 * 60 * 60 * 1000)), // 45 days ago
          dueDate: createDateString(new Date(today.getTime() - 31 * 24 * 60 * 60 * 1000)), // Due 31 days ago
          status: 'Paid'
        }
      ];
      
      // Add each invoice to the invoices array with necessary details
      sampleInvoices.forEach(inv => {
        const invoice = {
          id: inv.id,
          type: 'Invoice',
          customer: inv.customer,
          customerEmail: inv.customerEmail,
          date: inv.date,
          dueDate: inv.dueDate,
          items: [
            {
              description: 'Monthly Subscription',
              quantity: 1,
              price: inv.amount,
              total: inv.amount
            }
          ],
          subtotal: inv.amount,
          tax: (parseFloat(inv.amount) * 0.2).toFixed(2),
          total: (parseFloat(inv.amount) * 1.2).toFixed(2),
          notes: 'Thank you for your business!',
          status: inv.status
        };
        
        invoices.push(invoice);
      });
      
      // Update the invoices table
      updateInvoicesTable();
    }
    
    // Function to collect payment for an invoice
    function collectPaymentForInvoice(invoiceId) {
      // Find the invoice by ID
      const invoice = invoices.find(inv => inv.id === invoiceId);
      if (!invoice) {
        console.error('Invoice not found:', invoiceId);
        return;
      }
      
      // Store current invoice ID globally
      currentInvoiceId = invoiceId;
      console.log(`Setting current invoice ID: ${currentInvoiceId}`);
      
      // Open payment modal
      const modal = document.getElementById('paymentOptionModal');
      
      // Get the product-amount row
      const productAmountRow = document.querySelector('.product-amount-row');
      if (productAmountRow) {
        // Store original content to restore later
        if (!window.originalProductDiv) {
          const productDiv = productAmountRow.querySelector('div:first-child');
          window.originalProductDiv = productDiv.innerHTML;
        }
        
        // Replace product select with invoice ID field
        const productDiv = productAmountRow.querySelector('div:first-child');
        if (productDiv) {
          productDiv.innerHTML = `
            <label for="modalInvoiceId" style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 1rem;">Invoice ID</label>
            <input id="modalInvoiceId" style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem; background-color: #f0f0f0; color: #666;" type="text" value="${invoice.id}" readonly />
          `;
        }
        
        // Set amount to invoice total and make it read-only
        const amountInput = document.getElementById('modalAmountInput');
        if (amountInput) {
          amountInput.value = invoice.total;
          amountInput.readOnly = true;
          amountInput.style.backgroundColor = "var(--menu-bg-color)";
          amountInput.style.color = "var(--light-text-color)";
        }
      }
      
      // Set customer based on invoice
      const customerSelect = document.getElementById('customerSelect');
      if (customerSelect) {
        // Store original select element to restore later
        if (!window.originalCustomerSelect) {
          window.originalCustomerSelect = customerSelect.outerHTML;
        }
        
        // Set appropriate customer
        if (invoice.customer.includes('John')) {
          customerSelect.value = 'john';
        } else if (invoice.customer.includes('Oded')) {
          customerSelect.value = 'oded';
        }
        
        // Disable customer select
        customerSelect.disabled = true;
        customerSelect.style.backgroundColor = "var(--menu-bg-color)";
        customerSelect.style.color = "var(--light-text-color)";
        
        // Update saved card info based on customer
        updateSavedCardInfo();
      }
      
      // Open the modal
      openModal('paymentOptionModal');
    }
    
    // Update the invoices table in the sales invoices section
    function updateInvoicesTable() {
      const tableBody = document.getElementById('invoicesTableBody');
      if (!tableBody) {
        console.error('Invoice table body element not found');
        return;
      }

      console.log('Updating invoices table with current data:', invoices);
      tableBody.innerHTML = '';

      // Sort invoices by date (newest first)
      const sortedInvoices = [...invoices].sort((a, b) => {
        const dateA = new Date(a.date.split('/').reverse().join('-'));
        const dateB = new Date(b.date.split('/').reverse().join('-'));
        return dateB - dateA;
      });

      sortedInvoices.forEach(invoice => {
        if (invoice.type === 'Invoice') { // Only show invoices, not estimates
          console.log(`Rendering invoice ${invoice.id} with status: ${invoice.status}`);
          const row = document.createElement('tr');

          const statusColor = invoice.status === 'Paid' ?
            'color: #4caf50; font-weight: bold;' :
            'color: #ff9800; font-weight: bold;';
            
          // Check if invoice is overdue
          const today = new Date();
          const dueDate = new Date(invoice.dueDate.split('/').reverse().join('-'));
          const isOverdue = today > dueDate && invoice.status !== 'Paid';
          
          const dueDateStyle = isOverdue ? 
            'padding: 12px; border-bottom: 1px solid #eee; color: #f44336; font-weight: bold;' : 
            'padding: 12px; border-bottom: 1px solid #eee;';

                // Create action button based on status
      const actionButton = invoice.status !== 'Paid' ? 
        `<button class="btn" style="background: var(--secondary-color); padding: 6px 12px; font-size: 0.9rem; display: inline-block; width: 100px; text-align: center;" onclick="collectPaymentForInvoice('${invoice.id}')">Collect</button>` :
        '<span style="color: #999; display: inline-block; text-align: left;">—</span>';

      row.innerHTML = `
        <td data-label="Invoice ID" style="padding: 12px; border-bottom: 1px solid #eee;">
          <span style="color: var(--primary-color);">
            ${invoice.id}
          </span>
        </td>
        <td data-label="Customer" style="padding: 12px; border-bottom: 1px solid #eee;">${invoice.customer}</td>
        <td data-label="Amount" style="padding: 12px; border-bottom: 1px solid #eee;">£${invoice.total}</td>
        <td data-label="Date" style="padding: 12px; border-bottom: 1px solid #eee;">${invoice.date}</td>
        <td data-label="Due Date" style="${dueDateStyle}">${invoice.dueDate}</td>
        <td data-label="Status" style="padding: 12px; border-bottom: 1px solid #eee; ${statusColor}">${invoice.status}</td>
        <td data-label="Actions" style="padding: 12px; border-bottom: 1px solid #eee; min-width: 100px; text-align: left;">
          ${actionButton}
        </td>
      `;

          tableBody.appendChild(row);
        }
      });
    }
    
    // Close success modal
    function closeSuccessModal() {
      const modal = document.getElementById('successModal');
      if (modal) {
        modal.classList.remove('active');
        modal.style.display = 'none';
      }
      
      // Remove animation class from body
      document.body.classList.remove('modal-open');
    }

    function updateCardPayment(customerName, customerEmail) {
      // Show loading overlay during checkout creation
      const loadingOverlay = document.getElementById("loadingOverlay");
      if (loadingOverlay) {
        loadingOverlay.style.display = "flex";
      }
      
      // Validate vendor ID
      if (!globalVendorId) {
        if (loadingOverlay) loadingOverlay.style.display = "none";
        alert("Please toggle 'Onboard' first to set up a vendor.");
        return;
      }
      
      // Generate unique reference
      const timestamp = Date.now();
      const reference = `card_update_${timestamp}`;
      
      // Build checkout data
      const data = {
        amount: 0,
        currency: "GBP",
        country: "GB",
        email: customerEmail,
        storePaymentMethod: true,
        vendorId: globalVendorId,
        paymentMethods: ["card"],
        reference: reference,
        consumer: { 
          reference: `consumer_${timestamp}`,
          email: customerEmail,
          firstName: customerName.split(' ')[0],
          lastName: customerName.split(' ')[1] || ''
        }
      };
      
      console.log("Creating card update checkout with data:", data);
      
      fetch("https://sandbox.unipaas.com/platform/pay-ins/checkout", {
        method: "POST",
        headers: getApiHeaders(),
        body: JSON.stringify(data)
      })
        .then(r => {
          if (!r.ok) {
            return r.json().then(errorData => {
              throw new Error(`Network error, status=${r.status}: ${JSON.stringify(errorData)}`);
            });
          }
          return r.json();
        })
        .then(jsonData => {
          // Hide loading overlay
          if (loadingOverlay) {
            loadingOverlay.style.display = "none";
          }
          
          console.log("Card update checkout created successfully:", jsonData);
          
          // Update the payment link modal
          document.getElementById('updatePaymentLink').textContent = jsonData.shortLink;
          document.getElementById('updatePaymentLink').href = jsonData.shortLink;
          document.getElementById('updatePaymentQRCode').src =
            "https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=" + encodeURIComponent(jsonData.shortLink);
          
          // Open payment link modal
          openModal('updatePaymentModal');
          
          // Start the status timer
          startCardUpdateStatusTimer(jsonData.id, customerName, customerEmail);
        })
        .catch(err => {
          // Hide loading overlay
          if (loadingOverlay) {
            loadingOverlay.style.display = "none";
          }
          
          console.error("Error creating card update checkout:", err);
          alert("Error creating card update link: " + err.message);
        });
    }

    // Poll for card update checkout status
    let cardUpdateStatusTimer = null;

    function startCardUpdateStatusTimer(checkoutId, customerName, customerEmail) {
      // Validate checkout ID
      if (!checkoutId) {
        console.error("Cannot start timer: Invalid checkout ID");
        return;
      }

      console.log("Starting card update status timer for ID:", checkoutId);
      
      // Clear any existing timer
      if (cardUpdateStatusTimer) {
        clearInterval(cardUpdateStatusTimer);
      }
      
      // Start with the current time to handle timeouts
      const startTime = Date.now();
      
      // Start a new timer
      cardUpdateStatusTimer = setInterval(() => {
        // Check for timeout (after 300 seconds)
        const elapsed = (Date.now() - startTime) / 1000;
        if (elapsed > 300) {
          console.log("Card update status check timed out after 300 seconds");
          clearInterval(cardUpdateStatusTimer);
          return;
        }
        
        // Log that we're checking status
        console.log("Checking card update status for ID:", checkoutId);
        
        fetch(`https://sandbox.unipaas.com/platform/pay-ins/checkout/${checkoutId}`, {
          method: "GET",
          headers: getApiHeaders()
        })
          .then(r => {
            // Handle response errors
            if (!r.ok) {
              throw new Error(`Status check failed with status: ${r.status}`);
            }
            return r.json();
          })
          .then(data => {
            console.log('Card update status response:', data);
            
            // Check if checkout completed - looking for "paid" or "completed" status
            if (data.status && ['paid', 'completed'].includes(data.status.toLowerCase())) {
              console.log("Card update completed successfully!");
              
              // Stop polling
              clearInterval(cardUpdateStatusTimer);
              
              // Close modals
              closeModal('updatePaymentModal');
              closeFloatingModal();
              
              // Show success message
              alert(`Card updated successfully for ${customerName}!`);
            }
          })
          .catch(err => {
            console.error('Error checking card update status:', err);
          });
      }, 5000); // Check every 5 seconds
    }
    
    // TFC Checkout Modal Functions
    let tfcComponents = null;
    let tfcCheckoutComponent = null;
    let tfcScriptLoaded = false;
    
    function openTFCCheckoutModal(fromURL = false) {
      // Open the TFC modal
      openModal('tfcCheckoutModal');
      
      // Load TFC script and initialize checkout
      loadTFCScriptAndInitialize();
    }
    
    function loadTFCScriptAndInitialize() {
      // Check if we need to load the TFC script
      if (!tfcScriptLoaded) {
        // Create a separate script element for TFC
        const tfcScript = document.createElement('script');
        tfcScript.src = 'https://cdn.unipaas.com/embedded-components.js';
        tfcScript.onload = function() {
          tfcScriptLoaded = true;
          console.log('TFC script loaded successfully');
          setTimeout(createTFCTokenAndInitialize, 100); // Small delay to ensure script is ready
        };
        tfcScript.onerror = function() {
          console.error('Failed to load TFC script');
          alert('Failed to load TFC payment system. Please try again.');
        };
        
        // Add to head temporarily
        document.head.appendChild(tfcScript);
      } else {
        // Script already loaded, just create token and initialize
        createTFCTokenAndInitialize();
      }
    }
    
    function createTFCTokenAndInitialize() {
      // Check if we're coming back from HMRC redirect
      const urlParams = new URLSearchParams(window.location.search);
      const isRedirectBack = urlParams.get('tfc') === 'true';
      
      if (isRedirectBack) {
        // Try to get saved token from localStorage
        const savedTFCToken = localStorage.getItem('tfcAccessToken');
        if (savedTFCToken) {
          console.log('Using saved TFC token from localStorage');
          initializeTFCCheckout(savedTFCToken);
          return;
        }
      }
      
      // Generate random 9-digit references
      const generateRandomReference = () => Math.floor(100000000 + Math.random() * 900000000).toString();
      
      // Get amount from modal if available, otherwise default to 40
      let amount = 40;
      const amountInput = document.getElementById('modalAmountInput');
      if (amountInput && amountInput.value) {
        amount = parseFloat(amountInput.value) || 40;
      }
      
      // Get customer email
      let customerEmail = "hen.hadayo@unipaas.com";
      const customerSelect = document.getElementById('customerSelect');
      if (customerSelect) {
        if (customerSelect.value === 'sarah') {
          customerEmail = "sarah.johnson@gmail.com";
        } else if (customerSelect.value === 'michael') {
          customerEmail = "mike.mitchell@gmail.com";
        } else if (customerSelect.value === 'lisa') {
          customerEmail = "lisa.oconnor@gmail.com";
        }
      }
      
      // Get service description from product select
      let description = "Full day care";
      const productSelect = document.getElementById('modalProductSelect');
      if (productSelect && productSelect.selectedIndex >= 0) {
        const selectedOption = productSelect.options[productSelect.selectedIndex];
        description = selectedOption.text || "Full day care";
      }
      
      // Create TFC token request
      const tfcTokenRequest = {
        scopes: ["master"],
        email: customerEmail,
        reference: generateRandomReference(),
        description: description,
        consumer: {
          reference: generateRandomReference()
        },
        country: "GB",
        paymentMethods: ["taxFreeChildcare", "card"],
        currency: "GBP",
        amount: amount,
        vendorId: globalVendorId || "6847c40e23cb8d730cca6dbc",
        embeddedRedirect: "https://odedkovach.github.io/checkout/index.html?tfc=true"
      };
      
      console.log('Creating TFC token with request:', tfcTokenRequest);
      
      // Show loading state
      const checkoutContainer = document.getElementById('tfcCheckout');
      if (checkoutContainer) {
        checkoutContainer.innerHTML = '<div style="text-align: center; padding: 2rem;"><div class="spinner" style="margin: 0 auto 1rem;"></div><p>Creating TFC payment session...</p></div>';
      }
      
      // Create TFC token
      fetch("https://sandbox.unipaas.com/platform/pay-ins/checkout/", {
        method: "POST",
        headers: getApiHeaders(),
        body: JSON.stringify(tfcTokenRequest)
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`TFC token creation failed with status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        console.log('TFC token created successfully:', data);
        
        // The checkout endpoint might return different field names
        // Check for sessionToken, accessToken, or token fields
        const token = data.sessionToken || data.accessToken || data.token;
        
        if (token) {
          // Save token to localStorage
          localStorage.setItem('tfcAccessToken', token);
          console.log('TFC token saved to localStorage');
          
          // Initialize checkout with new token
          initializeTFCCheckout(token);
        } else {
          console.error('No token found in response:', data);
          throw new Error('No session token in response');
        }
      })
      .catch(error => {
        console.error('Error creating TFC token:', error);
        
        // Show error in checkout container
        if (checkoutContainer) {
          checkoutContainer.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: #e74c3c;">
              <p style="margin-bottom: 1rem;">Error creating TFC payment session</p>
              <button onclick="createTFCTokenAndInitialize()" style="padding: 0.5rem 1rem; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">
                Try Again
              </button>
            </div>
          `;
        }
        
        alert("Error creating TFC payment session: " + error.message);
      });
    }
    
    function initializeTFCCheckout(accessToken) {
      // Check if unipaas object is available
      if (typeof unipaas === 'undefined') {
        console.error('UniPaas object not available');
        alert('TFC payment system not ready. Please try again.');
        return;
      }
      
      // Clear any error states
      const checkoutContainer = document.getElementById('tfcCheckout');
      if (checkoutContainer) {
        checkoutContainer.innerHTML = '';
      }
      
      // TFC Theme configuration
      const tfcConfig = {
        theme: {
          type: "default"
        },
      };
      
      try {
        // Only initialize if not already done
        if (!tfcComponents) {
          console.log('Initializing TFC checkout components with dynamic token...');
          
          // Create the UniPaas buyerComponents object for TFC
          tfcComponents = unipaas.buyerComponents(accessToken, tfcConfig);
          
          // Listen to TFC payment events
          tfcComponents.on("paymentSuccess", (e) => {
            console.log("TFC Payment succeeded:", e.detail);
            
            // Clear saved token on success
            localStorage.removeItem('tfcAccessToken');
            
            // Close TFC modal
            // closeModal('tfcCheckoutModal');
            
            // Clean up TFC components
            // cleanupTFCComponents();
            
            // Show success message
            setTimeout(() => {
              // alert("TFC Payment succeeded!");
            }, 500);
          });
          
          tfcComponents.on("paymentError", (e) => {
            console.log("TFC Payment error:", e.detail);
            alert("TFC Payment error occurred!");
          });
          
          tfcComponents.on("paymentCancel", (e) => {
            console.log("TFC Payment canceled:", e.detail);
            alert("TFC Payment was canceled by the user.");
          });
        }
        
        // Create and mount the TFC checkout component
        if (!tfcCheckoutComponent) {
          console.log('Creating TFC checkout component...');
          tfcCheckoutComponent = tfcComponents.create("checkout");
          tfcCheckoutComponent.mount("#tfcCheckout");
        }
        
      } catch (error) {
        console.error("Error initializing TFC checkout:", error);
        alert("Error initializing TFC checkout. Please try again.");
      }
    }
    
    function cleanupTFCComponents() {
      try {
        // Unmount the checkout component
        if (tfcCheckoutComponent) {
          console.log('Cleaning up TFC checkout component...');
          tfcCheckoutComponent.unmount();
          tfcCheckoutComponent = null;
        }
        
        // Reset components
        if (tfcComponents) {
          tfcComponents = null;
        }
        
        // Clear the checkout container
        const checkoutContainer = document.getElementById('tfcCheckout');
        if (checkoutContainer) {
          checkoutContainer.innerHTML = '';
        }
        
      } catch (error) {
        console.error('Error cleaning up TFC components:', error);
      }
    }
    
    // Override the closeModal function to handle TFC cleanup
    const originalCloseModal = window.closeModal;
    window.closeModal = function(modalId) {
      if (modalId === 'tfcCheckoutModal') {
        // Clean up TFC components when modal is closed
        cleanupTFCComponents();
        // Clear saved token when modal is manually closed
        localStorage.removeItem('tfcAccessToken');
      }
      originalCloseModal(modalId);
    };
  </script>
</body>
</html> 